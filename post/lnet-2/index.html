<!DOCTYPE html>
<html lang="en"><head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terence Liu</title>
    <meta charset="utf-8">
    <meta name="description" content="Ladder@üë®‚Äçüíª My Personal Experimental Network: L-Net 1.1 - Terence Liu">
    <meta name="author" content="Terence Liu">
    <link rel="canonical" href="https://blog.cklau.cc/post/lnet-2/">

    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-B5D427G9NW"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-B5D427G9NW', { 'anonymize_ip': false });
}
</script>



    <meta property="og:title" content="üë®‚Äçüíª My Personal Experimental Network: L-Net 1.1" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.cklau.cc/post/lnet-2/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-12-26T00:16:21+08:00" />
<meta property="article:modified_time" content="2022-12-26T00:16:21+08:00" />
<meta property="og:see_also" content="https://blog.cklau.cc/post/lnet-3/" /><meta property="og:see_also" content="https://blog.cklau.cc/post/lnet-1/" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="üë®‚Äçüíª My Personal Experimental Network: L-Net 1.1"/>
<meta name="twitter:description" content=""/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://blog.cklau.cc/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "üë®‚Äçüíª My Personal Experimental Network: L-Net 1.1",
      "item": "https://blog.cklau.cc/post/lnet-2/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "üë®‚Äçüíª My Personal Experimental Network: L-Net 1.1",
  "name": "üë®‚Äçüíª My Personal Experimental Network: L-Net 1.1",
  "description": "",
  "keywords": [
    "networking", "wireguard", "BGP", "experimental network"
  ],
  "articleBody": "Before In the previous project: Homelab, I create a experimental network and I call it L-Net 1.0. However, I am trying to redesign the network as I am trying to maximize the usage of all the bandwidth, route auto-correction, and manage the resources based on one machine outside the cluster. Here is the diagram:\nHere, as usual, I made three network areas, ‚ÄúEast-Asia-CN‚Äù is 192.168.101.0/24 , ‚ÄúSoutheast-Asia-HKSAR‚Äú is 192.168.102.0/24, and ‚ÄúEast-Aisa-JP‚Äú is 192.168.103.0/24. As you can see, I draw three routers in the diagram, but it is four, and I will explain why. For the backbone network, For Mainland China $\\Leftrightarrow$ HKSAR is 10.255.101.0/24, Mainland China $\\Leftrightarrow$ Japan is 10.255.102.0/24 and Japan $\\Leftrightarrow$ HKSAR is 10.255.103.0/24. One more thing, I combine my Singapore server into the ‚ÄúSoutheast-Asia-HK‚Äú network as I only have one server in South Asia, and the combination can reduce multiple configurations.\nHOWTO Wireguard Yes, I still use my script wgtools to generate the Wireguard configuration. However, if we try to use iBGP inside the network area, we need to create a star-shaped network and disable changing the routing table. Here is an example:\n################################# #### Configuration of router #### ################################# [Interface] Address = 192.168.101.1/32,fd4f:3f1f:d743:0:ccce:d274:c262:ff9b/128 ListenPort = 51820 PrivateKey = Table = off [Peer] # Name = node-1 PublicKey = AllowedIPs = 192.168.101.2/32,fd4f:3f1f:d743:0:f8e3:c5be:c0fa:dd2f/128 PersistentKeepalive = 25 Endpoint = :51820 [Peer] # Name = node-2 PublicKey = AllowedIPs = 192.168.101.3/32,fd4f:3f1f:d743:0:8174:fd0f:3627:4c50/128 PersistentKeepalive = 25 Endpoint = :51820 ################################# #### Configuration of node-1 #### ################################# [Interface] Address = 192.168.101.1/32,fd4f:3f1f:d743:0:ccce:d274:c262:ff9b/128 ListenPort = 51820 PrivateKey = Table = off [Peer] # Name = router PublicKey = AllowedIPs = 0.0.0.0/0,::/0 PersistentKeepalive = 25 Endpoint = :51820 As you can see that we set Table = off For routers, we need to set the connection to other nodes; for other nodes, we need to set the AllowedIPs = 0.0.0.0/0, ::/0 to allow routing based on the iBGP.\neBGP and iBGP After setting up the Wirewuard, we need to set up the eBGP and iBGP. Let‚Äôs set up the iBGP first:\nsudo apt-get install bird2 # install bird2 in both routers and nodes Create template sudo vim /etc/bird/template.conf, by creating a template we can import the template for duplicated setting:\n# https://bird.network.cz/?get_doc define LOCAL_ASN = ; define NET = [] # mark down all the ip in all the net area template bgp tpl_ibgp { local as LOCAL_ASN; # med metric on; path metric on; error wait time 5, 10; # Minimum and maximum delay in seconds between a protocol failure (either local or reported by the peer) and automatic restart. Doesn not apply when disable after error is configured. If consecutive errors happen, the delay is increased exponentially until it reaches the maximum. Default: 60, 300. error forget time 20; # Maximum time in seconds between two protocol failures to treat them as a error sequence which makes error wait time increase exponentially. multihop 1; graceful restart on; ipv4 { import filter { if net ~ NET then accept; reject; }; export filter { if net ~ NET then accept; reject; }; next hop self; gateway recursive; # since we are using multihop we cannot use gateway direct }; } Set up the /etc/bird/bird.conf:\n############# # for router: router id ; include \"/etc/bird/template.conf\"; protocol device { scan time 5; } protocol kernel { ipv4 { import all; export all; }; merge paths on; } protocol direct { ipv4; interface \"\"; } protocol static cn { ipv4; route via \"\"; route via \"\"; } protocol bgp cantor from tpl_ibgp { neighbor internal; rr client; } ############# # for node 1: router id ; include \"/etc/bird/template.conf\"; protocol device { scan time 5; } protocol kernel { ipv4 { import all; export all; }; merge paths on; } protocol direct { ipv4; interface \"\"; } protocol static cn { ipv4; route via \"\"; } protocol bgp cantor from tpl_ibgp { neighbor internal; rr client; } Here you can see that we create a static route between the router and node-1, and this could be seen as the PostUp = ip addr add peer dev %i in Wireguard configuration. After the configuration of bird we can simply use sudo birdc c \u0026\u0026 sudo birc show protocols to check whether the iBGP is established.\nFor the eBGP part, it is similar to the iBGP part, we need a template and settings:\n### At Template in Both router-1 and router-2 # https://bird.network.cz/?get_doc define LOCAL_ASN = ; define NET = [] # mark down all the ip in all the net area template bgp tpl_ebgp { local as LOCAL_ASN; path metric 1; direct; graceful restart on; ipv4 { import filter { if net ~ NET then accept; reject; }; export filter { if net ~ NET then accept; reject; }; next hop self; gateway direct; }; } For the settings:\n############# /etc/bird/bird.conf # for router-1: # ... add a new protocol bgp protocol bgp area1_area_2 from tpl_ebgp { neighbor as router2_ASN; } ############# /etc/bird/bird.conf # for router-2: # ... add a new protocol bgp protocol bgp area_2_area_1 from tpl_ebgp { neighbor as router1_ASN; } After the configuration, we can easily build a link-local and pseudo-link-global network by using the BGP protocol. In these configurations, I use IP address as the filter, you may try ASN as the filter, here is an example,\nfilter FILTER_ASN int set accept_asn; { accept_asn = [area1_ASN, area2_ASN, area3_ASN]; if bgp_path.last ~ accept_asn then { accept; } reject; } template bgp tpl_ebgp { local as LOCAL_ASN; path metric 1; direct; graceful restart on; ipv4 { import filter FILTER_ASN; export filter FILTER_ASN; next hop self; gateway direct; }; } Here are some points you may concern about:\nIf your router is needed to be attached, the backbone network‚Äôs CIDR needs to be accepted by the BGP, I try multiple times but I did not fix this issue. Inside a network area, all nodes are in a star topology network and the router is the root node. This means if the router is down, the connections between nodes are also down. You may use wgsd to establish a direct connection inside the network area. Wireguard multiplexing? In the standard Wireguard, each interface corresponds to one port and if we have multiple different settings configuration we may lost in the port selection or just do not remember the which port percisely link to the interface. Under this circumstance, I use gost to aggregate the interfaces‚Äô ports into one port.\n# download the latest version from github wget https://github.com/ginuerzh/gost/releases/download/v2.11.4/gost-linux-amd64-2.11.4.gz gzip -d gost-linux-amd64-2.11.4.gz sudo mv gost-linux-amd64-2.11.4 /usr/local/bin/gost \u0026\u0026 sudo chmow +x /usr/local/bin/gost sudo cat \u003e /etc/systemd/system/gost.service \u003c\u003c EOF [Unit] Description=Gost Proxy After=network.target Wants=network.target [Service] Type=simple ExecStart=/usr/local/bin/gost -C /etc/gost/config.json Restart=always [Install] WantedBy=multi-user.target EOF mkdir /etc/gost cat \u003e /etc/gost/config.json \u003c\u003c EOF { \"Debug\": true, \"Retries\": 0, \"ServeNodes\": [ \"udp://:51820/127.0.0.1:51821,127.0.0.1:51822,127.0.0.1:21823\" ] } EOF sudo systemctl enable --now gost Then, we can use 51820 for all three interface‚Äôs connection.\n",
  "wordCount" : "1156",
  "inLanguage": "en",
  "datePublished": "2022-12-26T00:16:21+08:00",
  "dateModified": "2022-12-26T00:16:21+08:00",
  "author":{
    "@type": "Person",
    "name": "Terence Liu"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.cklau.cc/post/lnet-2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Terence Liu",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.cklau.cc/favicon.ico"
    }
  }
}
</script>
    <link rel="icon" type="image/png" href="/images/icon.png" sizes="16x16">

<link rel="apple-touch-icon" href="/images/icon.png">

<link rel="manifest" href="/images/icon.png">

    
    
    
    <link rel="stylesheet" href="/css/main.min.64bc8c4cb2304e84167c1583fa1b5de80f6d5adc95abed2e616dea0ea5680e01.css" integrity="sha256-ZLyMTLIwToQWfBWD&#43;htd6A9tWtyVq&#43;0uYW3qDqVoDgE=" crossorigin="anonymous" media="screen" />
    


    
    <link rel="stylesheet" href="/scss/highlight/github-dark.min.min.66034289ee9a113219a2c4aae0a8bd2095ab255c832a42efcf5863f10814e7a1.css" />

    
    <script src="/js/highlight.min.min.c098d85b5396dec4707ea2cead1445b4dc2ff0fc56b8dbbd9049d0d1c50ad237.js"></script>
    <script>hljs.highlightAll();</script>

    <script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script>
    </head>
<body>
      <main class="wrapper"><nav class="navigation">
    <section class="container">
        <a class="navigation-brand" href="/">
            CKLAU&#39;s Blog
        </a>
        <input type="checkbox" id="menu-toggle" />
        <label class="menu-button float-right" for="menu-toggle">
            <span></span><span></span><span></span>
        </label>
        
        <ul class="navigation-list" id="navigation-list">
            
            
            <li class="navigation-item navigation-menu">
                <a class="navigation-link" href="/post">Blog</a>
            </li>
            
            <li class="navigation-item navigation-menu">
                <a class="navigation-link" href="/tags">Tags</a>
            </li>
            
            <li class="navigation-item navigation-menu">
                <a class="navigation-link" href="/projects">Project</a>
            </li>
            
            

            <li class="navigation-item menu-separator">
                <span>|</span>
            </li>

            
            
            <li class="navigation-item navigation-social">
                <a class="navigation-link" href="https://github.com/TerenceLiu98"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a>
            </li>
            
            

            <li class="navigation-item navigation-dark">
                <button id="mode" type="button" aria-label="toggle user light or dark theme">
                    <span class="toggle-dark"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg></span>
                    <span class="toggle-light"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></span>
                </button>
            </li>

            
            
            
            
            
            
            
            <li class="navigation-item navigation-language">
                <a href="https://blog.cklau.cc/zh/">‰∏≠</a>
            </li>
            
            
            
            
        </ul>
        
    </section>
</nav>
<div id="content">
<article class="blog-single">
  <header class="blog-title">
    <h1>üë®‚Äçüíª My Personal Experimental Network: L-Net 1.1</h1>
  </header>

  <p>
  <small>
    December 26, 2022&nbsp;¬∑ 1156 words&nbsp;¬∑ 6 min</small>
  <small>
    
    ¬∑
    
    
    <a href="https://blog.cklau.cc/tags/networking/">networking</a>
    
    <a href="https://blog.cklau.cc/tags/wireguard/">wireguard</a>
    
    <a href="https://blog.cklau.cc/tags/bgp/">BGP</a>
    
    <a href="https://blog.cklau.cc/tags/experimental-network/">experimental network</a>
    
  </small>
<p>

  <div class="blog-toc">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#before">Before</a></li>
    <li><a href="#howto">HOWTO</a></li>
    <li><a href="#wireguard">Wireguard</a>
      <ul>
        <li><a href="#ebgp-and-ibgp">eBGP and iBGP</a></li>
      </ul>
    </li>
    <li><a href="#wireguard-multiplexing">Wireguard multiplexing?</a></li>
  </ul>
</nav>
  </div>

  <section class="blog-content"><h2 id="before">Before</h2>
<p>In the previous project: <a href="https://blog.cklau.cc/post/lnet-1/" title="My Personal Experimental Network">Homelab</a>, I create a experimental network and I call it L-Net 1.0. However, I am trying to redesign the network as I am trying to maximize the usage of all the bandwidth,  route auto-correction, and manage the resources based on one machine outside the cluster. Here is the diagram:</p>
<p><img src="https://s3.cklau.cc/outline/uploads/f96d0f35-cf0a-46bd-aeca-b1a1ac9052c9/fee27882-b91c-4a86-b6fa-cb4f2e779982/lnet.png" alt="L-Net 1.1"></p>
<p>Here, as usual, I made three network areas, ‚ÄúEast-Asia-CN‚Äù is <code>192.168.101.0/24</code> , ‚ÄúSoutheast-Asia-HKSAR‚Äú is <code>192.168.102.0/24</code>, and ‚ÄúEast-Aisa-JP‚Äú is <code>192.168.103.0/24</code>.  As you can see, I draw three routers in the diagram, but it is four, and I will explain why. For the backbone network, For Mainland China $\Leftrightarrow$ HKSAR is <code>10.255.101.0/24</code>,  Mainland China $\Leftrightarrow$ Japan is <code>10.255.102.0/24</code> and Japan $\Leftrightarrow$ HKSAR  is <code>10.255.103.0/24</code>. One more thing, I combine my Singapore server into the ‚ÄúSoutheast-Asia-HK‚Äú network as I only have one server in South Asia, and the combination can reduce multiple configurations.</p>
<h2 id="howto">HOWTO</h2>
<h2 id="wireguard">Wireguard</h2>
<p>Yes, I still use my script <a href="https://github.com/TerenceLiu98/wgtools">wgtools</a> to generate the Wireguard configuration. However, if we try to use iBGP inside the network area, we need to create a star-shaped network and disable changing the routing table. Here is an example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#################################</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### Configuration of router ####</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#################################</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Interface<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Address <span style="color:#f92672">=</span> 192.168.101.1/32,fd4f:3f1f:d743:0:ccce:d274:c262:ff9b/128
</span></span><span style="display:flex;"><span>ListenPort <span style="color:#f92672">=</span> <span style="color:#ae81ff">51820</span>
</span></span><span style="display:flex;"><span>PrivateKey <span style="color:#f92672">=</span> &lt;router-private-key&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Table <span style="color:#f92672">=</span> off
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Peer<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Name = node-1</span>
</span></span><span style="display:flex;"><span>PublicKey <span style="color:#f92672">=</span> &lt;node-1-public-key&gt;
</span></span><span style="display:flex;"><span>AllowedIPs <span style="color:#f92672">=</span> 192.168.101.2/32,fd4f:3f1f:d743:0:f8e3:c5be:c0fa:dd2f/128
</span></span><span style="display:flex;"><span>PersistentKeepalive <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>
</span></span><span style="display:flex;"><span>Endpoint <span style="color:#f92672">=</span> &lt;node-1-ip-address&gt;:51820
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Peer<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Name = node-2</span>
</span></span><span style="display:flex;"><span>PublicKey <span style="color:#f92672">=</span> &lt;node-3-public-key&gt;
</span></span><span style="display:flex;"><span>AllowedIPs <span style="color:#f92672">=</span> 192.168.101.3/32,fd4f:3f1f:d743:0:8174:fd0f:3627:4c50/128
</span></span><span style="display:flex;"><span>PersistentKeepalive <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>
</span></span><span style="display:flex;"><span>Endpoint <span style="color:#f92672">=</span> &lt;node-2-ip-address&gt;:51820
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#################################</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### Configuration of node-1 ####</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#################################</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Interface<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Address <span style="color:#f92672">=</span> 192.168.101.1/32,fd4f:3f1f:d743:0:ccce:d274:c262:ff9b/128
</span></span><span style="display:flex;"><span>ListenPort <span style="color:#f92672">=</span> <span style="color:#ae81ff">51820</span>
</span></span><span style="display:flex;"><span>PrivateKey <span style="color:#f92672">=</span> &lt;node-1-private-key&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Table <span style="color:#f92672">=</span> off
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Peer<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Name = router</span>
</span></span><span style="display:flex;"><span>PublicKey <span style="color:#f92672">=</span> &lt;router-public-key&gt;
</span></span><span style="display:flex;"><span>AllowedIPs <span style="color:#f92672">=</span> 0.0.0.0/0,::/0
</span></span><span style="display:flex;"><span>PersistentKeepalive <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>
</span></span><span style="display:flex;"><span>Endpoint <span style="color:#f92672">=</span> &lt;rnode-1-ip-address&gt;:51820
</span></span></code></pre></div><p>As you can see that we set <code>Table = off</code>  For routers, we need to set the connection to other nodes; for other nodes, we need to set the <code>AllowedIPs = 0.0.0.0/0, ::/0</code> to allow routing based on the iBGP.</p>
<h3 id="ebgp-and-ibgp">eBGP and iBGP</h3>
<p>After setting up the Wirewuard, we need to set up the eBGP and iBGP. Let&rsquo;s set up the iBGP first:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt-get install bird2 <span style="color:#75715e"># install bird2 in both routers and nodes</span>
</span></span></code></pre></div><p>Create template <code>sudo vim /etc/bird/template.conf</code>, by creating a template we can import the template for duplicated setting:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># https://bird.network.cz/?get_doc</span>
</span></span><span style="display:flex;"><span>define LOCAL_ASN <span style="color:#f92672">=</span> &lt;net-area-ASN&gt;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>define NET <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span> <span style="color:#75715e"># mark down all the ip in all the net area</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>template bgp tpl_ibgp <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    local as LOCAL_ASN; <span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span>    med metric on;
</span></span><span style="display:flex;"><span>    path metric on;
</span></span><span style="display:flex;"><span>    error wait time 5, 10; <span style="color:#75715e"># Minimum and maximum delay in seconds between a protocol failure (either local or reported by the peer) and automatic restart. Doesn not apply when disable after error is configured. If consecutive errors happen, the delay is increased exponentially until it reaches the maximum. Default: 60, 300.</span>
</span></span><span style="display:flex;"><span>    error forget time 20; <span style="color:#75715e"># Maximum time in seconds between two protocol failures to treat them as a error sequence which makes error wait time increase exponentially.</span>
</span></span><span style="display:flex;"><span>    multihop 1;
</span></span><span style="display:flex;"><span>    graceful restart on;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ipv4 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        import filter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> net ~ NET <span style="color:#66d9ef">then</span> accept;
</span></span><span style="display:flex;"><span>            reject;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>        export filter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> net ~ NET <span style="color:#66d9ef">then</span> accept;
</span></span><span style="display:flex;"><span>            reject;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>        next hop self;
</span></span><span style="display:flex;"><span>        gateway recursive; <span style="color:#75715e"># since we are using multihop we cannot use gateway direct</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Set up the <code>/etc/bird/bird.conf</code>:</p>
<pre tabindex="0"><code>#############
# for router:
router id &lt;router-id&gt;;

include &#34;/etc/bird/template.conf&#34;;

protocol device {
    scan time 5;
}

protocol kernel {
    ipv4 {
        import all;
        export all;
    };
    merge paths on;
}

protocol direct {
    ipv4;
    interface &#34;&lt;wg-interface-name&gt;&#34;;
}

protocol static cn {
    ipv4;
    route &lt;node-1-ip&gt; via &#34;&lt;wg-interface-name&gt;&#34;;
    route &lt;node-2-ip&gt; via &#34;&lt;wg-interface-name&gt;&#34;;
}

protocol bgp cantor from tpl_ibgp {
    neighbor &lt;node-2-ip&gt; internal;
    rr client;
}


#############
# for node 1:
router id &lt;node-1-id&gt;;

include &#34;/etc/bird/template.conf&#34;;

protocol device {
    scan time 5;
}

protocol kernel {
    ipv4 {
        import all;
        export all;
    };
    merge paths on;
}

protocol direct {
    ipv4;
    interface &#34;&lt;wg-interface-name&gt;&#34;;
}

protocol static cn {
    ipv4;
    route &lt;router-ip&gt; via &#34;&lt;wg-interface-name&gt;&#34;;
}

protocol bgp cantor from tpl_ibgp {
    neighbor &lt;router-ip&gt; internal;
    rr client;
}
</code></pre><p>Here you can see that we create a static route between the router and node-1, and this could be seen as the <code>PostUp = ip addr add &lt;local-ip&gt; peer &lt;remote-ip&gt; dev %i</code>  in Wireguard configuration.  After the configuration of bird we can simply use <code>sudo birdc c &amp;&amp; sudo birc show protocols</code> to check whether the iBGP is established.</p>
<p>For the eBGP part, it is similar to the iBGP part, we need a template and settings:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">### At Template in Both router-1 and router-2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># https://bird.network.cz/?get_doc</span>
</span></span><span style="display:flex;"><span>define LOCAL_ASN <span style="color:#f92672">=</span> &lt;net-area-ASN&gt;;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>define NET <span style="color:#f92672">=</span> <span style="color:#f92672">[]</span> <span style="color:#75715e"># mark down all the ip in all the net area</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>template bgp tpl_ebgp <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    local as LOCAL_ASN;
</span></span><span style="display:flex;"><span>    path metric 1;
</span></span><span style="display:flex;"><span>    direct;
</span></span><span style="display:flex;"><span>    graceful restart on;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ipv4 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        import filter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> net ~ NET <span style="color:#66d9ef">then</span> accept;
</span></span><span style="display:flex;"><span>            reject;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>        export filter <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> net ~ NET <span style="color:#66d9ef">then</span> accept;
</span></span><span style="display:flex;"><span>            reject;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>        next hop self;
</span></span><span style="display:flex;"><span>        gateway direct;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>For the settings:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">############# /etc/bird/bird.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for router-1:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ... add a new protocol bgp </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>protocol bgp area1_area_2 from tpl_ebgp <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    neighbor &lt;router2-ip&gt; as router2_ASN;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">############# /etc/bird/bird.conf</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># for router-2:</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ... add a new protocol bgp </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>protocol bgp area_2_area_1 from tpl_ebgp <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    neighbor &lt;router1-ip&gt; as router1_ASN;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>After the configuration, we can easily build a link-local and pseudo-link-global network by using the BGP protocol. In these configurations, I use IP address as the filter, you may try ASN as the filter, here is an example,</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>filter FILTER_ASN
</span></span><span style="display:flex;"><span>int set accept_asn; <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    accept_asn <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>area1_ASN, area2_ASN, area3_ASN<span style="color:#f92672">]</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> bgp_path.last ~ accept_asn <span style="color:#66d9ef">then</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        accept;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    reject;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>template bgp tpl_ebgp <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    local as LOCAL_ASN;
</span></span><span style="display:flex;"><span>    path metric 1;
</span></span><span style="display:flex;"><span>    direct;
</span></span><span style="display:flex;"><span>    graceful restart on;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ipv4 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        import filter FILTER_ASN;
</span></span><span style="display:flex;"><span>        export filter FILTER_ASN;
</span></span><span style="display:flex;"><span>        next hop self;
</span></span><span style="display:flex;"><span>        gateway direct;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Here are some points you may concern about:</p>
<ol>
<li>If your router is needed to be attached, the backbone network‚Äôs CIDR needs to be accepted by the BGP, I try multiple times but I did not fix this issue.</li>
<li>Inside a network area, all nodes are in a  star topology network and the router is the root node. This means if the router is down, the connections between nodes are also down. You may use wgsd to establish a direct connection inside the network area.</li>
</ol>
<h2 id="wireguard-multiplexing">Wireguard multiplexing?</h2>
<p>In the standard Wireguard, each interface corresponds to one port and if we have multiple different settings configuration we may lost in the port selection or just do not remember the which port percisely link to the interface. Under this circumstance, I use <a href="https://github.com/ginuerzh/gost">gost</a> to aggregate the interfaces&rsquo; ports into one port.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># download the latest version from github</span>
</span></span><span style="display:flex;"><span>wget https://github.com/ginuerzh/gost/releases/download/v2.11.4/gost-linux-amd64-2.11.4.gz
</span></span><span style="display:flex;"><span>gzip -d gost-linux-amd64-2.11.4.gz
</span></span><span style="display:flex;"><span>sudo mv gost-linux-amd64-2.11.4 /usr/local/bin/gost <span style="color:#f92672">&amp;&amp;</span> sudo chmow +x /usr/local/bin/gost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo cat &gt; /etc/systemd/system/gost.service <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=Gost Proxy
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Wants=network.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=simple
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/local/bin/gost -C /etc/gost/config.json
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Restart=always
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mkdir /etc/gost
</span></span><span style="display:flex;"><span>cat &gt; /etc/gost/config.json <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;Debug&#34;: true,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;Retries&#34;: 0,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;ServeNodes&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;udp://:51820/127.0.0.1:51821,127.0.0.1:51822,127.0.0.1:21823&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo systemctl enable --now gost
</span></span></code></pre></div><p>Then, we can use <code>51820</code> for all three interface&rsquo;s connection.</p></section>

  
  
  <div class="paginator">
    
    <a class="prev" href="https://blog.cklau.cc/post/lnet-3/"><span>&larr;&nbsp;&nbsp;</span><span>üë®‚Äçüíª My Personal Experimental Network: L-Net 1.2</span></a>
    
    
    <a class="next" href="https://blog.cklau.cc/post/my-homelab-5/"><span>Homelab: How to build a AIO home-server</span><span>&nbsp;&nbsp;&rarr;</span></a>
    
  </div>
  

  

<div class="related-resources">
  <h3>Related Resources</h3>
  
    
    
    
      <nav>
        <ul>
        
        
          
            <li>
              <a href="/post/lnet-3/">üë®‚Äçüíª My Personal Experimental Network: L-Net 1.2</a>
            </li>
          
        
          
        
          
            <li>
              <a href="/post/lnet-1/">üë®‚Äçüíª My Personal Experimental Network: L-Net</a>
            </li>
          
        
        </ul>
      </nav>
    
  
</div>


</article>

        </div><footer class="footer">
  <p>&copy; 2023 <a href="https://blog.cklau.cc">Terence Liu</a> &nbsp;
    <a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">Á≤§ICPÂ§á2022102668Âè∑</a>
Ô∏è  </p>
</footer>

<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
</a>

<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>

<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'Copy';

        function copyingDone() {
            copybutton.innerHTML = 'Copied';
            setTimeout(() => {
                copybutton.innerHTML = 'Copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });
        codeblock.parentNode.appendChild(copybutton);
    });
</script></main>
    </body><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
      const images = Array.from(document.querySelectorAll(".blog-content img"));
      images.forEach(img => {
          mediumZoom(img, {
              margin: 10,  
              scrollOffset: 40,  
              container: null,  
              template: null,  
              background: 'rgba(0, 0, 0, 0.5)'
          });
      });
  </script>

  
  <script src="/main.min.6bb26b69159420159c74dc9e097b06a578ed2b68c701466a91a44a9632d851bd0af167a1b30012387b4c512b48ad9ad4d3394e04d77ae38d57e1920fe4ed34fe.js" integrity="sha512-a7JraRWUIBWcdNyeCXsGpXjtK2jHAUZqkaRKljLYUb0K8WehswASOHtMUStIrZrU0zlOBNd6441X4ZIP5O00/g==" crossorigin="anonymous" defer></script></html>
