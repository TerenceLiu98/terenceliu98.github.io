<!DOCTYPE html>


































<html
  class="not-ready text-sm lg:text-base"
  style="--bg: #faf6f1"
  lang="en"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>👨‍💻 My Personal Experimental Network: L-Net - Terence Lau</title>

  
  <meta name="theme-color" />
  
  <meta name="description" content="Before In the previous project: Homelab, I listed all my devices and VPS on a table, where all the VPS own a specific public IP, and I tried to use the Wireguard to connect them into a Full-mesh intranet.
However, to investigate deeper into the network performance, I started to learn how to federate these clusters while not affecting the current usage. What&rsquo;s more, if I can federate this isolated network, I don&rsquo;t need to build separate services in different clusters." />
  <meta name="author" content="" />
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://blog.cklau.cc/main.min.css" />

  
  <script
    defer
    src="https://blog.cklau.cc/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  
  <link
    rel="preload"
    as="image"
    href="https://blog.cklau.cc/theme.png"
  />

  
  
  
  <link rel="preload" as="image" href="https://gravatar.xingez.me/avatar/805f51891ad1a60cd19e3e4e7539f319?s=160&amp;d=identicon" />
  
  

  
  <link rel="preload" as="image" href="https://blog.cklau.cc/github.svg" />
  
  <link rel="preload" as="image" href="https://blog.cklau.cc/rss.svg" />
  

  
  <link rel="icon" href="https://blog.cklau.cc/favicon.ico" />
  <link rel="apple-touch-icon" href="https://blog.cklau.cc/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.89.4" />

  
  

  
  
  
  
  
  
  
  
  
  <meta property="og:title" content="👨‍💻 My Personal Experimental Network: L-Net" />
<meta property="og:description" content="Before In the previous project: Homelab, I listed all my devices and VPS on a table, where all the VPS own a specific public IP, and I tried to use the Wireguard to connect them into a Full-mesh intranet.
However, to investigate deeper into the network performance, I started to learn how to federate these clusters while not affecting the current usage. What&rsquo;s more, if I can federate this isolated network, I don&rsquo;t need to build separate services in different clusters." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.cklau.cc/post/lnet-1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-10-18T00:11:21+08:00" />



  
  <meta itemprop="name" content="👨‍💻 My Personal Experimental Network: L-Net">
<meta itemprop="description" content="Before In the previous project: Homelab, I listed all my devices and VPS on a table, where all the VPS own a specific public IP, and I tried to use the Wireguard to connect them into a Full-mesh intranet.
However, to investigate deeper into the network performance, I started to learn how to federate these clusters while not affecting the current usage. What&rsquo;s more, if I can federate this isolated network, I don&rsquo;t need to build separate services in different clusters."><meta itemprop="datePublished" content="2022-10-18T00:11:21+08:00" />

<meta itemprop="wordCount" content="1845">
<meta itemprop="keywords" content="networking,wireguard,experimental network," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="👨‍💻 My Personal Experimental Network: L-Net"/>
<meta name="twitter:description" content="Before In the previous project: Homelab, I listed all my devices and VPS on a table, where all the VPS own a specific public IP, and I tried to use the Wireguard to connect them into a Full-mesh intranet.
However, to investigate deeper into the network performance, I started to learn how to federate these clusters while not affecting the current usage. What&rsquo;s more, if I can federate this isolated network, I don&rsquo;t need to build separate services in different clusters."/>

  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold" href="https://blog.cklau.cc"
      >Terence Lau</a
    >
    <a
      class="btn-dark ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
    ></a>
  </div>

  <a
    class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
  ></a>

  
  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = `"#faf6f1"`.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    const darkVal = localStorage.getItem('dark');
    setDark(darkVal ? darkVal === 'true' : darkScheme.matches);

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    
    <nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6">
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/about/"
        >About</a
      >
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/friends/"
        >Friends</a
      >
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/projects/"
        >Projects</a
      >
      
    </nav>
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:mt-0 lg:ml-12 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href=" https://github.com/TerenceLiu98 "
        target="_blank"
      ></a>
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./rss.svg)"
        href=" https://blog.cklau.cc/index.xml "
        target="_blank"
      ></a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-8 pt-20 pb-32 dark:prose-invert"
    >
      

<article>
  <header class="mb-10">
    <h1 class="!my-0 pb-2.5">👨‍💻 My Personal Experimental Network: L-Net</h1>

    
    <div class="text-sm opacity-60">
      
      
      
      
      Published Oct 17, 2022
      
      
      
    </div>
    
  </header>


  
     
    <a
      class="mr-1.5 mb-1.5 rounded-lg bg-black/[3%] px-2 py-1 no-underline dark:bg-white/[8%]"
      href="https://blog.cklau.cc/tags/networking"
      >networking</a>
     
    <a
      class="mr-1.5 mb-1.5 rounded-lg bg-black/[3%] px-2 py-1 no-underline dark:bg-white/[8%]"
      href="https://blog.cklau.cc/tags/wireguard"
      >wireguard</a>
     
    <a
      class="mr-1.5 mb-1.5 rounded-lg bg-black/[3%] px-2 py-1 no-underline dark:bg-white/[8%]"
      href="https://blog.cklau.cc/tags/experimental-network"
      >experimental network</a>
    
  
  <hr>
  <section><h2 id="before">Before</h2>
<p>In the previous project: <a href="https://blog.cklau.cc/post/my-homelab-1/" title="My Homelab 2">Homelab</a>, I listed all my devices and VPS on a table, where all the VPS own a specific public IP, and I tried to use the Wireguard to connect them into a Full-mesh intranet.</p>
<p>However, to investigate deeper into the network performance, I started to learn how to federate these clusters while not affecting the current usage. What&rsquo;s more, if I can federate this isolated network, I don&rsquo;t need to build separate services in different clusters. For instance, I can use a single <a href="https://prometheus.io/">Prometheus</a> to monitor all the devices and no more millions of virtual interfaces :rofl:</p>
<h2 id="design">Design</h2>
<p>We are using the <code>Wireguard</code> to generate the virtual network interface for each node or each cluster. Between the cluster’s router, we also generate an isolated Wireguard tunnel between two nodes. Here is an example: <code>a1</code> is the router of the cluster <code>A</code> and <code>b</code> is the central router of the whole L-Net and <code>A</code>’s IP address is <code>172.12.1.0/24</code> , then we need an extra IP address(an extra Wireguard tunnel) for <code>a → b</code>.</p>
<p>Under this circumstance, we can connect the nodes inside the <code>A (a2, a3, …)</code>  to <code>b</code>, and other nodes  from <code>C (c1, c2, c3, …)</code> can also connect to <code>A</code>.</p>
<p>Here is the topology of my design:</p>
<p><img src="https://bucket.cklau.cc/outline-bucket/uploads/f96d0f35-cf0a-46bd-aeca-b1a1ac9052c9/dc88ca70-d652-4d2b-9360-931c852ea1b3/LNet.drawio.png" alt="toppology"></p>
<p>Those bold-colored dotted lines can be seen as the Backbone network, and the slim-colored dotted lines can be seen as the internet/intranet. The slim-black dotted line shows that cross IP range is accessible as long as the client allows the traffic.</p>
<h2 id="network-configuration">Network Configuration</h2>
<h3 id="loc-1---mainland-china">Loc 1 - Mainland, China</h3>
<ol>
<li>
<p>Network Interface: <code>cn</code></p>
<ol>
<li>IP address: <code>192.168.10.0/24</code></li>
<li>Allowed IP: <code>192.168.141.x/32, 192.168.{20,30}.0/24</code></li>
</ol>
</li>
<li>
<p>Network Interface (Router): <code>sgcn</code></p>
<ol>
<li>IP address: <code>192.168.141.0/24</code></li>
<li>Allowed IP: <code>0.0.0.0/0</code></li>
</ol>
</li>
</ol>
<table>
<thead>
<tr>
<th>Service Provider</th>
<th>Location</th>
<th>Name</th>
<th>Public IP</th>
<th>Private IP</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tencent Cloud</td>
<td>GZ</td>
<td>newton</td>
<td>(secret)</td>
<td>192.168.10.1 / 192.168.141.2</td>
<td>Router</td>
</tr>
<tr>
<td>Tencent Cloud</td>
<td>SH</td>
<td>gauss</td>
<td>(secret)</td>
<td>192.168.10.2</td>
<td></td>
</tr>
<tr>
<td>Tencent Cloud</td>
<td>SH</td>
<td>cantor</td>
<td>(secret)</td>
<td>192.168.10.3</td>
<td></td>
</tr>
<tr>
<td>Tencent Cloud</td>
<td>SH</td>
<td>hilbert</td>
<td>(secret)</td>
<td>192.168.10.4</td>
<td></td>
</tr>
<tr>
<td>China Telecom Cloud</td>
<td>GZ</td>
<td>NA</td>
<td>(secret)</td>
<td>192.168.10.5</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="loc-2---japan">Loc 2 - Japan</h3>
<ol>
<li>
<p>Network Interface: <code>jp</code></p>
<ol>
<li>IP address: <code>192.168.20.0/24</code></li>
<li>Allowed IP: <code>192.168.142.0/32, 192.168.{10, 30}.0/24</code></li>
</ol>
</li>
<li>
<p>Network Interface (Router): <code>sgjp</code></p>
<ol>
<li>IP address: <code>192.168.142.0/24</code></li>
<li>Allowed IP: <code>0.0.0.0/0</code></li>
</ol>
</li>
</ol>
<table>
<thead>
<tr>
<th>Service Provider</th>
<th>Location</th>
<th>Name</th>
<th>Public IP</th>
<th>Private IP</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Oracle Cloud</td>
<td>JP</td>
<td>einstein</td>
<td>(secret)</td>
<td>192.168.20.1 / 192.168.142.2</td>
<td>Router</td>
</tr>
<tr>
<td>Oracle Cloud</td>
<td>JP</td>
<td>bohr</td>
<td>(secret)</td>
<td>192.168.20.2</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="loc-3---hksar-china">Loc 3 - HKSAR, China</h3>
<ol>
<li>
<p>Network Interface: <code>hk</code></p>
<ol>
<li>IP address: <code>192.168.30.0/24</code></li>
<li>Allowed IP: <code>192.168.143.0/32, 192.168.{20, 30}.0/24</code></li>
</ol>
</li>
<li>
<p>Network Interface (Router): <code>sghk</code></p>
<ol>
<li>IP address: <code>192.168.143.0/24</code></li>
<li>Allowed IP: <code>0.0.0.0/0</code></li>
</ol>
</li>
</ol>
<table>
<thead>
<tr>
<th>Service Provider</th>
<th>Location</th>
<th>Name</th>
<th>Public IP</th>
<th>Private IP</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cube Cloud</td>
<td>HK</td>
<td>turing</td>
<td>(secret)</td>
<td>192.168.30.3 / 192.168.143.2</td>
<td>Router</td>
</tr>
<tr>
<td>Tencent Cloud</td>
<td>HK</td>
<td>neumann</td>
<td>(secret)</td>
<td>192.168.30.1</td>
<td></td>
</tr>
<tr>
<td>Tencent Cloud</td>
<td>HK</td>
<td>hinton</td>
<td>(secret)</td>
<td>192.168.30.2</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="loc-4---singapore">Loc 4 - Singapore</h3>
<ol>
<li>
<p>Network Interface: <code>sgcn</code></p>
<ol>
<li>IP address: <code>192.168.141.0/24</code></li>
<li>Allowed IP: <code>0.0.0.0/0</code></li>
</ol>
</li>
<li>
<p>Network Interface: <code>sgjp</code></p>
<ol>
<li>IP address: <code>192.168.142.0/24</code></li>
<li>Allowed IP: <code>0.0.0.0/0</code></li>
</ol>
</li>
<li>
<p>Network Interface: <code>sghk</code></p>
<ol>
<li>IP address: <code>192.168.143.0/24</code></li>
<li>Allowed IP: <code>0.0.0.0/0</code></li>
</ol>
</li>
</ol>
<table>
<thead>
<tr>
<th>Service Provider</th>
<th>Location</th>
<th>Name</th>
<th>Public IP</th>
<th>Private IP</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tencent Cloud</td>
<td>SG</td>
<td>bayes</td>
<td>(secret)</td>
<td>192.168.141.1 / 192.168.142.1 / 192.168.143.1</td>
<td>Central Router</td>
</tr>
</tbody>
</table>
<h2 id="configuration">Configuration</h2>
<h3 id="backbone-network">“Backbone Network”</h3>
<p>As usual, I use the tool I wrote <a href="https://github.com/TerenceLiu98/wgtools">wgtools</a> to generate Wireguard configuration. However, the tool is built for the full-mesh configuration, thus, for the “backbone” network, we need to modify the config, here is an example: in the  <code>sgcn</code>  interface, I put the following settings in <code>bayes</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>Interface<span style="color:#f92672">]</span>
Address <span style="color:#f92672">=</span> 192.168.141.1/24
ListenPort <span style="color:#f92672">=</span> <span style="color:#ae81ff">51821</span>
PrivateKey <span style="color:#f92672">=</span> &lt;interface-prikey&gt;

Table <span style="color:#f92672">=</span> off

<span style="color:#f92672">[</span>Peer<span style="color:#f92672">]</span>
<span style="color:#75715e"># Name = cn-router</span>
PublicKey <span style="color:#f92672">=</span> &lt;peer-pubkey&gt;
AllowedIPs <span style="color:#f92672">=</span> 0.0.0.0/0
PersistentKeepalive <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>
Endpoint <span style="color:#f92672">=</span> xxx.xxx.xxx.xxx:51821
</code></pre></div><p>The reason why we need to set the Address of the Interface to <code>/24</code> is that if we want the subnet of <code>newton</code> are accessible, which means that <code>192.168.141.2/32</code> need to be accessible from both sides as it is the bridge between <code>sgcn</code> and <code>cn</code> as the <code>sgcn</code> the interface is the bridge between the “external” to the “internal”. Here is the setting in <code>newton</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>Interface<span style="color:#f92672">]</span>
Address <span style="color:#f92672">=</span> 192.168.141.2/24 <span style="color:#75715e"># the same reason, this interface is the &#34;bridge&#34; </span>
ListenPort <span style="color:#f92672">=</span> <span style="color:#ae81ff">51821</span>
PrivateKey <span style="color:#f92672">=</span> cJgoIHnDfCl+p8D7KE0jCBkRipEwe3K6Jq7FG8OTzlo<span style="color:#f92672">=</span>

Table <span style="color:#f92672">=</span> off

<span style="color:#f92672">[</span>Peer<span style="color:#f92672">]</span>
<span style="color:#75715e"># Name = bayes</span>
PublicKey <span style="color:#f92672">=</span> FF85tV+bkTWA3rNHpn+sapA/08JV7HO92y/I1P+xsRE<span style="color:#f92672">=</span>
AllowedIPs <span style="color:#f92672">=</span> 0.0.0.0/0
PersistentKeepalive <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>
Endpoint <span style="color:#f92672">=</span> xxx.xxx.xxx.xxx:51821
</code></pre></div><p>Similarly, you can modify the Address and Endpoint for <code>sgjp</code> and <code>sghk</code> .</p>
<h3 id="intranetinternet">“Intranet/Internet”</h3>
<p>It is easy to generate the configuration with my tools, or maybe you can generate them manually, which is not the key for the configuration. The important part is that for each node of the “intranet“, you can control which other subnet can access to you. Take <code>gauss</code> and <code>einstein</code> as an example, if you want <code>gauss</code> can access from the <code>einstein</code> then you need to add the address of <code>einstein</code> in the <code>newton</code>’s <code>AllowedIPs</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># configuration of gauss</span>
<span style="color:#f92672">[</span>Interface<span style="color:#f92672">]</span>
Address <span style="color:#f92672">=</span> 192.168.10.2/32,fd0b:76a0:952b:0:afa3:e03c:fe6d:2e55/128
ListenPort <span style="color:#f92672">=</span> <span style="color:#ae81ff">51820</span>
PrivateKey <span style="color:#f92672">=</span> &lt;gauss-privkey&gt;

PostUp <span style="color:#f92672">=</span> iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown <span style="color:#f92672">=</span> iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

<span style="color:#f92672">[</span>Peer<span style="color:#f92672">]</span>
<span style="color:#75715e"># Name = newton</span>
PublicKey <span style="color:#f92672">=</span> &lt;newton-pubkey&gt;
AllowedIPs <span style="color:#f92672">=</span> 192.168.20.1/32,192.168.248.1/32,fd0b:76a0:952b:0:e96f:2dae:80a8:b578/128
PersistentKeepalive <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>
Endpoint <span style="color:#f92672">=</span> xxx.xxx.xxx.xxx:51820
</code></pre></div><p>This is because <code>newton</code> is the bridge between <code>cn</code> and <code>jp</code> , or more specifically, the <code>einstein</code> ‘s traffic needs to go through the <code>jp → sgjp → sgcn → cn</code> , and for <code>sgcn → cn</code> you need to add the <code>192.168.20.1/32</code> in the <code>AllowedIPs</code> and <code>cn</code> will know that this traffic can be accepted by the <code>cn</code> and it’s routed via the <code>192.168.248.1/32</code>.</p>
<h3 id="wireguard-site-to-site-configuration">Wireguard Site-to-Site Configuration</h3>
<p>For intuitive thinking, we need to connect cn-router, hksar-router, jp-router, with three different tunnel, however, from here I choose <code>OSPF(Open Shortest Path First, an Internal Gateway Protocol, or IGP)</code> and <code>iBGP(Interior Border Gateway Protocol)</code> to resolve the routing problem.</p>
<p>There are multiple different tools we can use: <code>bird2</code>, <code>quagga</code>, and etc.. I use <code>bird2</code> in here.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo apt-get install bird2 <span style="color:#f92672">&amp;&amp;</span> sudo systemctl stop bird2
</code></pre></div><p>The reason why I stop the process at first is that I don&rsquo;t want the &ldquo;bad&rdquo; configuration to influence the network.</p>
<h4 id="ospf---open-shortest-path-frist">OSPF - Open Shortest Path Frist</h4>
<p>OSPF is an interior gateway protocol (IGP) that routes packets within a single autonomous system (AS). OSPF uses link-state information to make routing decisions, making route calculations using the shortest-path-first (SPF) algorithm (also referred to as the Dijkstra algorithm). Each router running OSPF floods link-state advertisements throughout the AS or area that contain information about that router’s attached interfaces and routing metrics. Each router uses the information in these link-state advertisements to calculate the least cost path to each network and create a routing table for the protocol.</p>
<p>First, let&rsquo;s try OSPF first.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">## cn-router</span>
router id 192.168.199.1;

protocol device <span style="color:#f92672">{</span>
<span style="color:#f92672">}</span>
protocol kernel <span style="color:#f92672">{</span>
    ipv4 <span style="color:#f92672">{</span>
        export where proto <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wg&#34;</span>;
    <span style="color:#f92672">}</span>;
<span style="color:#f92672">}</span>

protocol ospf v2 sgcn <span style="color:#f92672">{</span>
    ipv4 <span style="color:#f92672">{</span>
        import where net !~ 192.168.141.0/24;
        export all;
    <span style="color:#f92672">}</span>;
    area 192.168.141.0 <span style="color:#f92672">{</span>
        interface <span style="color:#e6db74">&#34;sgcn&#34;</span>;
    <span style="color:#f92672">}</span>;
<span style="color:#f92672">}</span>

protocol ospf v2 cn <span style="color:#f92672">{</span>
    ipv4 <span style="color:#f92672">{</span>
        export all;
    <span style="color:#f92672">}</span>;
    area 192.168.10.0 <span style="color:#f92672">{</span>
        interface <span style="color:#e6db74">&#34;cn&#34;</span>;
    <span style="color:#f92672">}</span>;
<span style="color:#f92672">}</span>
</code></pre></div><p>where <code>router id</code> is the specific id for the router, it looks like a IP address, however, it actually just arbitrary 32-bit numbers that are by convection written in dotted-quad notation.</p>
<ul>
<li><code>protocol deive</code> help use to get information about netowkr interfaces from the kernel</li>
<li><code>protocol kernel</code> performs synchronization of BIRD&rsquo;s routing tables with the OS kernel and here we export the <code>wg</code> protocol&rsquo;s routing</li>
<li><code>protocol ospf v2 sgcn</code> sets up the the OSPFv2 instance we&rsquo;ll use for the wireguard connection. Note that the <code>sgcn</code> is the id I give to this instance, it can be arbitrary id; we import all the routes it receives over OSPF into its routing table and <code>export all;</code>.
<ul>
<li>The <code>import where net !~ 192.168.141.0/24;</code> line configures BIRD to avoid pulling in any routes to the <code>192.168.141.0/24</code> subnet from OSPF — this is the subnet we’re using for the WireGuard connection between <code>cn-router</code> and <code>sg-router</code>. This route is already set up in the <code>/etc/wireguard/sgcn.conf</code>.</li>
<li>The <code>area 192.168.141.0</code> block configures BIRD to use the area with an ID of <code>192.168.141.0</code> for OSPF on the specified interface. This ID is also an arbitrary 32-bit number. The <code>interface &quot;sgcn&quot;</code> specifies that the <code>sgcn</code> interface we set up is included in the area definition.</li>
</ul>
</li>
</ul>
<p>With this setting, the router will listen for and setd out OSPF broadcasts on the <code>sgcn</code> interface, importing the routes learned from OSPF into the table, and exporting the other routes in its table to share over OSPF. As you can se <code>protocol ospf v2 cn</code> is the OSPF for the <code>cn</code> LAN.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># start bird</span>
sudo systemctl start bird
<span style="color:#75715e"># check birdc status</span>
sudo birdc 
<span style="color:#75715e"># reload configuration</span>
sudo birdc configurate
<span style="color:#75715e"># check ospf </span>
sudo birdc show ospf
<span style="color:#75715e"># check route table</span>
sudo birdc show route
</code></pre></div><p>With the above configuration, <code>cn-router</code> and <code>sg-router</code> can communicate and exchange routing table, the next step is to propagate <code>cn</code> and to <code>sg</code>&rsquo;s node. We can still use <code>OSPF</code> for routing.</p>
<p><img src="https://bucket.cklau.cc/outline-bucket/uploads/f96d0f35-cf0a-46bd-aeca-b1a1ac9052c9/18362fae-26e4-403b-9c54-79b1fe7539e9/ospf-lnet.png" alt="ospf routing"></p>
<p>As you can see, two LAN OSPF can sharing the local routing table to each other via the <code>sgcn</code> and <code>sgjp</code>.</p>
<h4 id="ibgp---interior-border-gateway-protocol">iBGP - Interior Border Gateway Protocol</h4>
<p>IBGP is used inside the autonomous systems. It is used to provide information to your internal routers. It requires all the devices in same autonomous systems to form full mesh topology or either of Route reflectors and Confederation for prefix learning.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># configuration of cn-router</span>
router id 192.168.199.1;
define LOCAL_ASN <span style="color:#f92672">=</span> 4242420100;

protocol device <span style="color:#f92672">{</span>
<span style="color:#f92672">}</span>
protocol kernel <span style="color:#f92672">{</span>
    ipv4 <span style="color:#f92672">{</span>
        export where proto <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wg&#34;</span>;
    <span style="color:#f92672">}</span>;
<span style="color:#f92672">}</span>

protocol ospf v2 wg <span style="color:#f92672">{</span>
    ipv4 <span style="color:#f92672">{</span>
        import where net !~ 192.168.141.0/24;
        export all;
    <span style="color:#f92672">}</span>;
    area 192.168.141.0 <span style="color:#f92672">{</span>
        interface <span style="color:#e6db74">&#34;sgcn&#34;</span>;
    <span style="color:#f92672">}</span>;
<span style="color:#f92672">}</span>

protocol direct <span style="color:#f92672">{</span>
    ipv4;
    interface <span style="color:#e6db74">&#34;cn&#34;</span>;
<span style="color:#f92672">}</span>

protocol bgp lnet_sgcn <span style="color:#f92672">{</span>
    local 192.168.141.2 as 4242420100;
    neighbor 192.168.141.1 as 4242420100;
    multihop 1;
    graceful restart on;
    rr client;

    ipv4 <span style="color:#f92672">{</span>
        import all;
        export all;
    <span style="color:#f92672">}</span>;
<span style="color:#f92672">}</span>
</code></pre></div><ul>
<li><code>protocal direct</code> block with the actual name of the roter&rsquo;s LAN interface, for here, my router&rsquo;s LAN interface is <code>cn</code>. The <code>protocal direct</code> is required as it is used to import the direct interface routes for the LAN interface into BIRD&rsquo;s routing table, so that it can add the correct next hop to the routes from the other site that it will share via BGP.</li>
<li><code>protocal bgp lnet</code> is used to define the BGP section, again, the <code>lnet_sgnn</code> is just arbitrary ID for the protocal, you can use any word/number you want.</li>
<li><code>export all</code> directs BIRD to share all the rotes in the routing table with the other iBGP server. <code>next hop self</code> directs it to adjust those roures to make the Wireguard router itself the next hop in all those routes. This will share the rotes the Wireguard roter learned from the other site, using the Wireguard router it elf as the link to the site.</li>
<li><code>local 192.168.141.2 as 424220100</code> and <code>neighbor 192.168.141.1 as 424220100</code> is defining the AS number of local machine and the neighbor. If these two ASN are the same, we are defining a <code>iBGP</code> and if there are different we are defining a <code>eBGP</code>.</li>
</ul>
<p>For now, I have tried <code>OSPF</code> and <code>iBGP</code>. But I just simply follow the instruction and did not dig into the high-level setting.</p>
</section>

  
  

  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a class="flex w-1/2 items-center p-6 pr-3 no-underline" href="https://blog.cklau.cc/post/my-homelab-5/"
      ><span class="mr-1.5">←</span><span>Homelab: How to build a AIO home-server</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end p-6 pl-3 no-underline"
      href="https://blog.cklau.cc/post/k3s-setup-extra-1/"
      ><span>K3s/Kubernetes - Set up a K3s Cluster with your VPS (Extra Story 1)</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  

  
  
  <div id="disqus_thread"></div>
  <script>
    const disqusShortname = 'blog-cklau-cc';
    const script = document.createElement('script');
    script.src = 'https://' + disqusShortname + '.disqus.com/embed.js';
    script.setAttribute('data-timestamp', +new Date());
    document.head.appendChild(script);
  </script>
  
</article>


    </main>

    <footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-80">
  <div class="mr-auto">
    
    <a href="https://beian.miit.gov.cn">粤ICP备2022102668号</a>
  </div>
  The Object Storage Service is provided by <a class="link" href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral"><img src="/images/upyun.png" align="absmiddle" width="60px" height="30px"/></a>

  
</footer>

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1844674035384472"
     crossorigin="anonymous"></script>
  </body>
</html>
