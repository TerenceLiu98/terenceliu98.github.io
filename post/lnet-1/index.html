<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="https://blog.cklau.cc/images/logo.svg" />
<title>üë®‚Äçüíª My Personal Experimental Network: L-Net | ÁâπÂÄ´ËòáÁöÑÊó•ËàáÂ§ú</title>
<meta name="title" content="üë®‚Äçüíª My Personal Experimental Network: L-Net" />
<meta name="description" content="" />
<meta name="keywords" content="networking,wireguard,experimental network," />


<meta property="og:title" content="üë®‚Äçüíª My Personal Experimental Network: L-Net" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.cklau.cc/post/lnet-1/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-10-18T00:11:21+08:00" />
<meta property="article:modified_time" content="2022-10-18T00:11:21+08:00" />




<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="üë®‚Äçüíª My Personal Experimental Network: L-Net"/>
<meta name="twitter:description" content=""/>



<meta itemprop="name" content="üë®‚Äçüíª My Personal Experimental Network: L-Net">
<meta itemprop="description" content=""><meta itemprop="datePublished" content="2022-10-18T00:11:21+08:00" />
<meta itemprop="dateModified" content="2022-10-18T00:11:21+08:00" />
<meta itemprop="wordCount" content="1848">
<meta itemprop="keywords" content="networking,wireguard,experimental network," />
<meta name="referrer" content="no-referrer-when-downgrade" />

  <style>
  body {
    font-family: "Noto Serif SC", serif;
    font-weight: 500;
    font-style: normal;
    margin: auto;
    padding: 20px;
    max-width: 980px;
    text-align: left;
    background-color: #fff;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    color: #444;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6,
  strong,
  b {
    color: #222;
  }

  a {
    color: #444;
    text-decoration: none;
     
  }

  .title {
    text-decoration: none;
    border: 0;
  }

  .title span {
    font-weight: 400;
  }

  nav a {
    margin-right: 10px;
  }

  textarea {
    width: 100%;
    font-size: 16px;
  }

  input {
    font-size: 16px;
  }

  content {
    line-height: 1.6;
  }

  main content p a {
    word-wrap: break-word;
    border: none;
    box-shadow: inset 0 -2px #444;
    transition-property: box-shadow;
    transition-duration: .1s;
  }

  table {
    width: 100%;
  }

  img {
    max-width: 100%;
  }

  code {
    padding: 2px 5px;
    background-color: #f2f2f2;
  }

  pre code {
    color: #222;
    display: block;
    padding: 20px;
    white-space: pre-wrap;
    font-size: 14px;
    overflow-x: auto;
  }

  div.highlight pre {
    background-color: initial;
    color: initial;
  }

  div.highlight code {
    background-color: unset;
    color: unset;
  }

  blockquote {
    border-left: 1px solid #999;
    color: #222;
    padding-left: 20px;
    font-style: italic;
  }

  footer {
    padding: 25px;
    text-align: center;
  }

  .helptext {
    color: #777;
    font-size: small;
  }

  .errorlist {
    color: #eba613;
    font-size: small;
  }

   
  ul.blog-posts {
    list-style-type: none;
    padding: unset;
    line-height: 2;
  }

  ul.blog-posts li {
    display: flex;
  }

  ul.blog-posts li span {
    flex: 0 0 6.5rem;
  }

  ul.blog-posts li time {
    color: #8e8d8d;
  }

  ul.blog-posts li a:visited {
    color: #8b6fcb;
  }


   


  .bg { background-color: #f0f0f0; }
  .chroma { background-color: #f0f0f0; }
  .chroma .x {  }
  .chroma .err {  }
  .chroma .cl {  }
  .chroma .lnlinks { outline: none; text-decoration: none; color: inherit }
  .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
  .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; }
  .chroma .hl { background-color: #ffffcc }
  .chroma .lnt { white-space: pre; user-select: none; margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
  .chroma .ln { white-space: pre; user-select: none; margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
  .chroma .line { display: flex; }
  .chroma .k { color: #007020; font-weight: bold }
  .chroma .kc { color: #007020; font-weight: bold }
  .chroma .kd { color: #007020; font-weight: bold }
  .chroma .kn { color: #007020; font-weight: bold }
  .chroma .kp { color: #007020 }
  .chroma .kr { color: #007020; font-weight: bold }
  .chroma .kt { color: #902000 }
  .chroma .n {  }
  .chroma .na { color: #4070a0 }
  .chroma .nb { color: #007020 }
  .chroma .bp {  }
  .chroma .nc { color: #0e84b5; font-weight: bold }
  .chroma .no { color: #60add5 }
  .chroma .nd { color: #555555; font-weight: bold }
  .chroma .ni { color: #d55537; font-weight: bold }
  .chroma .ne { color: #007020 }
  .chroma .nf { color: #06287e }
  .chroma .fm {  }
  .chroma .nl { color: #002070; font-weight: bold }
  .chroma .nn { color: #0e84b5; font-weight: bold }
  .chroma .nx {  }
  .chroma .py {  }
  .chroma .nt { color: #062873; font-weight: bold }
  .chroma .nv { color: #bb60d5 }
  .chroma .vc {  }
  .chroma .vg {  }
  .chroma .vi {  }
  .chroma .vm {  }
  .chroma .l {  }
  .chroma .ld {  }
  .chroma .s { color: #4070a0 }
  .chroma .sa { color: #4070a0 }
  .chroma .sb { color: #4070a0 }
  .chroma .sc { color: #4070a0 }
  .chroma .dl { color: #4070a0 }
  .chroma .sd { color: #4070a0; font-style: italic }
  .chroma .s2 { color: #4070a0 }
  .chroma .se { color: #4070a0; font-weight: bold }
  .chroma .sh { color: #4070a0 }
  .chroma .si { color: #70a0d0 }
  .chroma .sx { color: #c65d09 }
  .chroma .sr { color: #235388 }
  .chroma .s1 { color: #4070a0 }
  .chroma .ss { color: #517918 }
  .chroma .m { color: #40a070 }
  .chroma .mb { color: #40a070 }
  .chroma .mf { color: #40a070 }
  .chroma .mh { color: #40a070 }
  .chroma .mi { color: #40a070 }
  .chroma .il { color: #40a070 }
  .chroma .mo { color: #40a070 }
  .chroma .o { color: #666666 }
  .chroma .ow { color: #007020; font-weight: bold }
  .chroma .p {  }
  .chroma .c { color: #60a0b0; font-style: italic }
  .chroma .ch { color: #60a0b0; font-style: italic }
  .chroma .cm { color: #60a0b0; font-style: italic }
  .chroma .c1 { color: #60a0b0; font-style: italic }
  .chroma .cs { color: #60a0b0; background-color: #fff0f0 }
  .chroma .cp { color: #007020 }
  .chroma .cpf { color: #007020 }
  .chroma .g {  }
  .chroma .gd { color: #a00000 }
  .chroma .ge { font-style: italic }
  .chroma .gr { color: #ff0000 }
  .chroma .gh { color: #000080; font-weight: bold }
  .chroma .gi { color: #00a000 }
  .chroma .go { color: #888888 }
  .chroma .gp { color: #c65d09; font-weight: bold }
  .chroma .gs { font-weight: bold }
  .chroma .gu { color: #800080; font-weight: bold }
  .chroma .gt { color: #0044dd }
  .chroma .gl { text-decoration: underline }
  .chroma .w { color: #bbbbbb }


 
.sidenote {
    font-size: 80%;         
    font-weight: normal;
    color: var(--theme-hl1-color);
    position: relative;     
}
 
@media (min-width: 1400px) {
    .sidenote {
        float: right;
        clear: right;            
        text-align: left;

         
            
        top: -3rem;             
        width: 20vw;            
        margin-right: -23vw;     
        margin-top: 1rem;       
    }
}
 
 
@media (max-width: 1400px) {
    .sidenote {
         
        float: right;
        text-align: left;

            
        width: 100%;  
        margin: 1rem 0;
        padding-left: 5%;  
    }
}
 
 
body {
    counter-reset: sidenote-counter;
}
.sidenote-number {
    counter-increment: sidenote-counter;
}
 
.sidenote::before {
    content: "\2020";
    position: relative;
    vertical-align: super;
    font-size: 0.9em;
    font-weight: bold;
}
 
.sidenote-number::after {
    content: "\2020";
    position: relative;
    vertical-align: super;
    font-size: 0.7em;
    font-weight: bold;
    color: var(--theme-body-color);
    display: inline;
    margin-right: 0.2rem;
}
@media (min-width: 1400px) {
     
    .sidenote-number:hover .sidenote {
        background-color: var(--theme-color-light);
    }
}

  
.card-container {
    display: flex;
    flex-direction: column;
    align-items: center;  
    gap: 5px;  
    padding: 5px;
}

.card {
    width: 80%;  
    box-shadow: 0 0px 0px rgba(0,0,0,0.1);  
    display: flex;
    align-items: center;  
    padding: 10px;
    background: white;  
    text-decoration: none;  
    color: inherit;  
}

.card img {
    width: 80px;  
    height: 80px;
    border-radius: 50%;  
    margin-right: 20px;  
}

.card .info h2 {
    margin: 0;
    font-size: 1.2em;  
}

.card .info p {
    margin: 5px 0 0;  
    font-size: 0.9em;
    color: #444;  
}
.card .info span{
    font-size: 0.5em;
    color: #666;
}
</style>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500&display=swap" rel="stylesheet">
<script defer data-domain="nova.moe" src="https://possible.knat.network/js/script.js"></script>
<link rel="alternate" type="application/rss+xml" href="https://blog.cklau.cc/feed.xml" title="ÁâπÂÄ´ËòáÁöÑÊó•ËàáÂ§ú">

  <link href="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet">
<script src="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.8/katex.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.8/contrib/auto-render.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/KaTeX/0.16.8/contrib/copy-tex.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        renderMathInElement(document.body, {
            
            
            delimiters: [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: true },
                { left: "\\begin{equation}", right: "\\end{equation}", display: true },
                { left: "\\begin{align}", right: "\\end{align}", display: true },
                { left: "\\begin{alignat}", right: "\\end{alignat}", display: true },
                { left: "\\begin{gather}", right: "\\end{gather}", display: true },
                { left: "\\begin{CD}", right: "\\end{CD}", display: true },
                { left: "\\[", right: "\\]", display: true }
            ],
            
            throwOnError: false,
            trust: (context) => ['\\htmlId', '\\href'].includes(context.command),
            macros: {
                "\\eqref": "\\href{###1}{(\\text{#1})}",
                "\\ref": "\\href{###1}{\\text{#1}}",
                "\\label": "\\htmlId{#1}{}"
            }
        });
    });
</script>
</head>

<body>
  <header><a href="/" class="title">
  <h2>ÁâπÂÄ´ËòáÁöÑÊó•ËàáÂ§ú</h2>
</a>
<nav><a href="/">Home</a>

<a href="/post">[Blog]</a>

<a href="/post/scientia">[Scientia]</a>

<a href="/links">[Links]</a>

</nav>
</header>
  <main>
<h1>üë®‚Äçüíª My Personal Experimental Network: L-Net</h1>
<p>
  <i>
    <time datetime='2022-10-18' pubdate>
      18 Oct, 2022
    </time>
  </i>
</p>

<content>
  <h2 id="before">Before</h2>
<p>In the previous project: <a href="https://blog.cklau.cc/post/my-homelab-1/" title="My Homelab 2">Homelab</a>, I listed all my devices and VPS on a table, where all the VPS own a specific public IP, and I tried to use the Wireguard to connect them into a Full-mesh intranet.</p>
<p>However, to investigate deeper into the network performance, I started to learn how to federate these clusters while not affecting the current usage. What&rsquo;s more, if I can federate this isolated network, I don&rsquo;t need to build separate services in different clusters. For instance, I can use a single <a href="https://prometheus.io/">Prometheus</a> to monitor all the devices and no more millions of virtual interfaces :rofl:</p>
<h2 id="design">Design</h2>
<p>We are using the <code>Wireguard</code> to generate the virtual network interface for each node or each cluster. Between the cluster‚Äôs router, we also generate an isolated Wireguard tunnel between two nodes. Here is an example: <code>a1</code> is the router of the cluster <code>A</code> and <code>b</code> is the central router of the whole L-Net and <code>A</code>‚Äôs IP address is <code>172.12.1.0/24</code> , then we need an extra IP address(an extra Wireguard tunnel) for <code>a ‚Üí b</code>.</p>
<p>Under this circumstance, we can connect the nodes inside the <code>A (a2, a3, ‚Ä¶)</code>  to <code>b</code>, and other nodes  from <code>C (c1, c2, c3, ‚Ä¶)</code> can also connect to <code>A</code>.</p>
<p>Here is the topology of my design:</p>
<p>Those bold-colored dotted lines can be seen as the Backbone network, and the slim-colored dotted lines can be seen as the internet/intranet. The slim-black dotted line shows that cross IP range is accessible as long as the client allows the traffic.</p>
<h2 id="network-configuration">Network Configuration</h2>
<h3 id="loc-1---mainland-china">Loc 1 - Mainland, China</h3>
<ol>
<li>
<p>Network Interface: <code>cn</code></p>
<ol>
<li>IP address: <code>192.168.10.0/24</code></li>
<li>Allowed IP: <code>192.168.141.x/32, 192.168.{20,30}.0/24</code></li>
</ol>
</li>
<li>
<p>Network Interface (Router): <code>sgcn</code></p>
<ol>
<li>IP address: <code>192.168.141.0/24</code></li>
<li>Allowed IP: <code>0.0.0.0/0</code></li>
</ol>
</li>
</ol>
<table>
<thead>
<tr>
<th>Service Provider</th>
<th>Location</th>
<th>Name</th>
<th>Public IP</th>
<th>Private IP</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tencent Cloud</td>
<td>GZ</td>
<td>newton</td>
<td>(secret)</td>
<td>192.168.10.1 / 192.168.141.2</td>
<td>Router</td>
</tr>
<tr>
<td>Tencent Cloud</td>
<td>SH</td>
<td>gauss</td>
<td>(secret)</td>
<td>192.168.10.2</td>
<td></td>
</tr>
<tr>
<td>Tencent Cloud</td>
<td>SH</td>
<td>cantor</td>
<td>(secret)</td>
<td>192.168.10.3</td>
<td></td>
</tr>
<tr>
<td>Tencent Cloud</td>
<td>SH</td>
<td>hilbert</td>
<td>(secret)</td>
<td>192.168.10.4</td>
<td></td>
</tr>
<tr>
<td>China Telecom Cloud</td>
<td>GZ</td>
<td>NA</td>
<td>(secret)</td>
<td>192.168.10.5</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="loc-2---japan">Loc 2 - Japan</h3>
<ol>
<li>
<p>Network Interface: <code>jp</code></p>
<ol>
<li>IP address: <code>192.168.20.0/24</code></li>
<li>Allowed IP: <code>192.168.142.0/32, 192.168.{10, 30}.0/24</code></li>
</ol>
</li>
<li>
<p>Network Interface (Router): <code>sgjp</code></p>
<ol>
<li>IP address: <code>192.168.142.0/24</code></li>
<li>Allowed IP: <code>0.0.0.0/0</code></li>
</ol>
</li>
</ol>
<table>
<thead>
<tr>
<th>Service Provider</th>
<th>Location</th>
<th>Name</th>
<th>Public IP</th>
<th>Private IP</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Oracle Cloud</td>
<td>JP</td>
<td>einstein</td>
<td>(secret)</td>
<td>192.168.20.1 / 192.168.142.2</td>
<td>Router</td>
</tr>
<tr>
<td>Oracle Cloud</td>
<td>JP</td>
<td>bohr</td>
<td>(secret)</td>
<td>192.168.20.2</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="loc-3---hksar-china">Loc 3 - HKSAR, China</h3>
<ol>
<li>
<p>Network Interface: <code>hk</code></p>
<ol>
<li>IP address: <code>192.168.30.0/24</code></li>
<li>Allowed IP: <code>192.168.143.0/32, 192.168.{20, 30}.0/24</code></li>
</ol>
</li>
<li>
<p>Network Interface (Router): <code>sghk</code></p>
<ol>
<li>IP address: <code>192.168.143.0/24</code></li>
<li>Allowed IP: <code>0.0.0.0/0</code></li>
</ol>
</li>
</ol>
<table>
<thead>
<tr>
<th>Service Provider</th>
<th>Location</th>
<th>Name</th>
<th>Public IP</th>
<th>Private IP</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cube Cloud</td>
<td>HK</td>
<td>turing</td>
<td>(secret)</td>
<td>192.168.30.3 / 192.168.143.2</td>
<td>Router</td>
</tr>
<tr>
<td>Tencent Cloud</td>
<td>HK</td>
<td>neumann</td>
<td>(secret)</td>
<td>192.168.30.1</td>
<td></td>
</tr>
<tr>
<td>Tencent Cloud</td>
<td>HK</td>
<td>hinton</td>
<td>(secret)</td>
<td>192.168.30.2</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="loc-4---singapore">Loc 4 - Singapore</h3>
<ol>
<li>
<p>Network Interface: <code>sgcn</code></p>
<ol>
<li>IP address: <code>192.168.141.0/24</code></li>
<li>Allowed IP: <code>0.0.0.0/0</code></li>
</ol>
</li>
<li>
<p>Network Interface: <code>sgjp</code></p>
<ol>
<li>IP address: <code>192.168.142.0/24</code></li>
<li>Allowed IP: <code>0.0.0.0/0</code></li>
</ol>
</li>
<li>
<p>Network Interface: <code>sghk</code></p>
<ol>
<li>IP address: <code>192.168.143.0/24</code></li>
<li>Allowed IP: <code>0.0.0.0/0</code></li>
</ol>
</li>
</ol>
<table>
<thead>
<tr>
<th>Service Provider</th>
<th>Location</th>
<th>Name</th>
<th>Public IP</th>
<th>Private IP</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Tencent Cloud</td>
<td>SG</td>
<td>bayes</td>
<td>(secret)</td>
<td>192.168.141.1 / 192.168.142.1 / 192.168.143.1</td>
<td>Central Router</td>
</tr>
</tbody>
</table>
<h2 id="configuration">Configuration</h2>
<h3 id="backbone-network">‚ÄúBackbone Network‚Äù</h3>
<p>As usual, I use the tool I wrote <a href="https://github.com/TerenceLiu98/wgtools">wgtools</a> to generate Wireguard configuration. However, the tool is built for the full-mesh configuration, thus, for the ‚Äúbackbone‚Äù network, we need to modify the config, here is an example: in the  <code>sgcn</code>  interface, I put the following settings in <code>bayes</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>Interface<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Address <span style="color:#f92672">=</span> 192.168.141.1/24
</span></span><span style="display:flex;"><span>ListenPort <span style="color:#f92672">=</span> <span style="color:#ae81ff">51821</span>
</span></span><span style="display:flex;"><span>PrivateKey <span style="color:#f92672">=</span> &lt;interface-prikey&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Table <span style="color:#f92672">=</span> off
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Peer<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Name = cn-router</span>
</span></span><span style="display:flex;"><span>PublicKey <span style="color:#f92672">=</span> &lt;peer-pubkey&gt;
</span></span><span style="display:flex;"><span>AllowedIPs <span style="color:#f92672">=</span> 0.0.0.0/0
</span></span><span style="display:flex;"><span>PersistentKeepalive <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>
</span></span><span style="display:flex;"><span>Endpoint <span style="color:#f92672">=</span> xxx.xxx.xxx.xxx:51821
</span></span></code></pre></div><p>The reason why we need to set the Address of the Interface to <code>/24</code> is that if we want the subnet of <code>newton</code> are accessible, which means that <code>192.168.141.2/32</code> need to be accessible from both sides as it is the bridge between <code>sgcn</code> and <code>cn</code> as the <code>sgcn</code> the interface is the bridge between the ‚Äúexternal‚Äù to the ‚Äúinternal‚Äù. Here is the setting in <code>newton</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>Interface<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Address <span style="color:#f92672">=</span> 192.168.141.2/24 <span style="color:#75715e"># the same reason, this interface is the &#34;bridge&#34; </span>
</span></span><span style="display:flex;"><span>ListenPort <span style="color:#f92672">=</span> <span style="color:#ae81ff">51821</span>
</span></span><span style="display:flex;"><span>PrivateKey <span style="color:#f92672">=</span> cJgoIHnDfCl+p8D7KE0jCBkRipEwe3K6Jq7FG8OTzlo<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Table <span style="color:#f92672">=</span> off
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Peer<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Name = bayes</span>
</span></span><span style="display:flex;"><span>PublicKey <span style="color:#f92672">=</span> FF85tV+bkTWA3rNHpn+sapA/08JV7HO92y/I1P+xsRE<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>AllowedIPs <span style="color:#f92672">=</span> 0.0.0.0/0
</span></span><span style="display:flex;"><span>PersistentKeepalive <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>
</span></span><span style="display:flex;"><span>Endpoint <span style="color:#f92672">=</span> xxx.xxx.xxx.xxx:51821
</span></span></code></pre></div><p>Similarly, you can modify the Address and Endpoint for <code>sgjp</code> and <code>sghk</code> .</p>
<h3 id="intranetinternet">‚ÄúIntranet/Internet‚Äù</h3>
<p>It is easy to generate the configuration with my tools, or maybe you can generate them manually, which is not the key for the configuration. The important part is that for each node of the ‚Äúintranet‚Äú, you can control which other subnet can access to you. Take <code>gauss</code> and <code>einstein</code> as an example, if you want <code>gauss</code> can access from the <code>einstein</code> then you need to add the address of <code>einstein</code> in the <code>newton</code>‚Äôs <code>AllowedIPs</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># configuration of gauss</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Interface<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Address <span style="color:#f92672">=</span> 192.168.10.2/32,fd0b:76a0:952b:0:afa3:e03c:fe6d:2e55/128
</span></span><span style="display:flex;"><span>ListenPort <span style="color:#f92672">=</span> <span style="color:#ae81ff">51820</span>
</span></span><span style="display:flex;"><span>PrivateKey <span style="color:#f92672">=</span> &lt;gauss-privkey&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PostUp <span style="color:#f92672">=</span> iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
</span></span><span style="display:flex;"><span>PostDown <span style="color:#f92672">=</span> iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Peer<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Name = newton</span>
</span></span><span style="display:flex;"><span>PublicKey <span style="color:#f92672">=</span> &lt;newton-pubkey&gt;
</span></span><span style="display:flex;"><span>AllowedIPs <span style="color:#f92672">=</span> 192.168.20.1/32,192.168.248.1/32,fd0b:76a0:952b:0:e96f:2dae:80a8:b578/128
</span></span><span style="display:flex;"><span>PersistentKeepalive <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>
</span></span><span style="display:flex;"><span>Endpoint <span style="color:#f92672">=</span> xxx.xxx.xxx.xxx:51820
</span></span></code></pre></div><p>This is because <code>newton</code> is the bridge between <code>cn</code> and <code>jp</code> , or more specifically, the <code>einstein</code> ‚Äòs traffic needs to go through the <code>jp ‚Üí sgjp ‚Üí sgcn ‚Üí cn</code> , and for <code>sgcn ‚Üí cn</code> you need to add the <code>192.168.20.1/32</code> in the <code>AllowedIPs</code> and <code>cn</code> will know that this traffic can be accepted by the <code>cn</code> and it‚Äôs routed via the <code>192.168.248.1/32</code>.</p>
<h3 id="wireguard-site-to-site-configuration">Wireguard Site-to-Site Configuration</h3>
<p>For intuitive thinking, we need to connect cn-router, hksar-router, jp-router, with three different tunnel, however, from here I choose <code>OSPF(Open Shortest Path First, an Internal Gateway Protocol, or IGP)</code> and <code>iBGP(Interior Border Gateway Protocol)</code> to resolve the routing problem.</p>
<p>There are multiple different tools we can use: <code>bird2</code>, <code>quagga</code>, and etc.. I use <code>bird2</code> in here.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt-get install bird2 <span style="color:#f92672">&amp;&amp;</span> sudo systemctl stop bird2
</span></span></code></pre></div><p>The reason why I stop the process at first is that I don&rsquo;t want the &ldquo;bad&rdquo; configuration to influence the network.</p>
<h4 id="ospf---open-shortest-path-frist">OSPF - Open Shortest Path Frist</h4>
<p>OSPF is an interior gateway protocol (IGP) that routes packets within a single autonomous system (AS). OSPF uses link-state information to make routing decisions, making route calculations using the shortest-path-first (SPF) algorithm (also referred to as the Dijkstra algorithm). Each router running OSPF floods link-state advertisements throughout the AS or area that contain information about that router‚Äôs attached interfaces and routing metrics. Each router uses the information in these link-state advertisements to calculate the least cost path to each network and create a routing table for the protocol.</p>
<p>First, let&rsquo;s try OSPF first.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">## cn-router</span>
</span></span><span style="display:flex;"><span>router id 192.168.199.1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>protocol device <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>protocol kernel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ipv4 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        export where proto <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wg&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>protocol ospf v2 sgcn <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ipv4 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        import where net !~ 192.168.141.0/24;
</span></span><span style="display:flex;"><span>        export all;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>    area 192.168.141.0 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        interface <span style="color:#e6db74">&#34;sgcn&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>protocol ospf v2 cn <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ipv4 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        export all;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>    area 192.168.10.0 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        interface <span style="color:#e6db74">&#34;cn&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>where <code>router id</code> is the specific id for the router, it looks like a IP address, however, it actually just arbitrary 32-bit numbers that are by convection written in dotted-quad notation.</p>
<ul>
<li><code>protocol deive</code> help use to get information about netowkr interfaces from the kernel</li>
<li><code>protocol kernel</code> performs synchronization of BIRD&rsquo;s routing tables with the OS kernel and here we export the <code>wg</code> protocol&rsquo;s routing</li>
<li><code>protocol ospf v2 sgcn</code> sets up the the OSPFv2 instance we&rsquo;ll use for the wireguard connection. Note that the <code>sgcn</code> is the id I give to this instance, it can be arbitrary id; we import all the routes it receives over OSPF into its routing table and <code>export all;</code>.
<ul>
<li>The <code>import where net !~ 192.168.141.0/24;</code> line configures BIRD to avoid pulling in any routes to the <code>192.168.141.0/24</code> subnet from OSPF‚Äâ‚Äî‚Äâthis is the subnet we‚Äôre using for the WireGuard connection between <code>cn-router</code> and <code>sg-router</code>. This route is already set up in the <code>/etc/wireguard/sgcn.conf</code>.</li>
<li>The <code>area 192.168.141.0</code> block configures BIRD to use the area with an ID of <code>192.168.141.0</code> for OSPF on the specified interface. This ID is also an arbitrary 32-bit number. The <code>interface &quot;sgcn&quot;</code> specifies that the <code>sgcn</code> interface we set up is included in the area definition.</li>
</ul>
</li>
</ul>
<p>With this setting, the router will listen for and setd out OSPF broadcasts on the <code>sgcn</code> interface, importing the routes learned from OSPF into the table, and exporting the other routes in its table to share over OSPF. As you can se <code>protocol ospf v2 cn</code> is the OSPF for the <code>cn</code> LAN.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># start bird</span>
</span></span><span style="display:flex;"><span>sudo systemctl start bird
</span></span><span style="display:flex;"><span><span style="color:#75715e"># check birdc status</span>
</span></span><span style="display:flex;"><span>sudo birdc 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># reload configuration</span>
</span></span><span style="display:flex;"><span>sudo birdc configurate
</span></span><span style="display:flex;"><span><span style="color:#75715e"># check ospf </span>
</span></span><span style="display:flex;"><span>sudo birdc show ospf
</span></span><span style="display:flex;"><span><span style="color:#75715e"># check route table</span>
</span></span><span style="display:flex;"><span>sudo birdc show route
</span></span></code></pre></div><p>With the above configuration, <code>cn-router</code> and <code>sg-router</code> can communicate and exchange routing table, the next step is to propagate <code>cn</code> and to <code>sg</code>&rsquo;s node. We can still use <code>OSPF</code> for routing.</p>
<p>As you can see, two LAN OSPF can sharing the local routing table to each other via the <code>sgcn</code> and <code>sgjp</code>.</p>
<h4 id="ibgp---interior-border-gateway-protocol">iBGP - Interior Border Gateway Protocol</h4>
<p>IBGP is used inside the autonomous systems. It is used to provide information to your internal routers. It requires all the devices in same autonomous systems to form full mesh topology or either of Route reflectors and Confederation for prefix learning.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># configuration of cn-router</span>
</span></span><span style="display:flex;"><span>router id 192.168.199.1;
</span></span><span style="display:flex;"><span>define LOCAL_ASN <span style="color:#f92672">=</span> 4242420100;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>protocol device <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>protocol kernel <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ipv4 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        export where proto <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wg&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>protocol ospf v2 wg <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ipv4 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        import where net !~ 192.168.141.0/24;
</span></span><span style="display:flex;"><span>        export all;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span>    area 192.168.141.0 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        interface <span style="color:#e6db74">&#34;sgcn&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>protocol direct <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ipv4;
</span></span><span style="display:flex;"><span>    interface <span style="color:#e6db74">&#34;cn&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>protocol bgp lnet_sgcn <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    local 192.168.141.2 as 4242420100;
</span></span><span style="display:flex;"><span>    neighbor 192.168.141.1 as 4242420100;
</span></span><span style="display:flex;"><span>    multihop 1;
</span></span><span style="display:flex;"><span>    graceful restart on;
</span></span><span style="display:flex;"><span>    rr client;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ipv4 <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        import all;
</span></span><span style="display:flex;"><span>        export all;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>;
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li><code>protocal direct</code> block with the actual name of the roter&rsquo;s LAN interface, for here, my router&rsquo;s LAN interface is <code>cn</code>. The <code>protocal direct</code> is required as it is used to import the direct interface routes for the LAN interface into BIRD&rsquo;s routing table, so that it can add the correct next hop to the routes from the other site that it will share via BGP.</li>
<li><code>protocal bgp lnet</code> is used to define the BGP section, again, the <code>lnet_sgnn</code> is just arbitrary ID for the protocal, you can use any word/number you want.</li>
<li><code>export all</code> directs BIRD to share all the rotes in the routing table with the other iBGP server. <code>next hop self</code> directs it to adjust those roures to make the Wireguard router itself the next hop in all those routes. This will share the rotes the Wireguard roter learned from the other site, using the Wireguard router it elf as the link to the site.</li>
<li><code>local 192.168.141.2 as 424220100</code> and <code>neighbor 192.168.141.1 as 424220100</code> is defining the AS number of local machine and the neighbor. If these two ASN are the same, we are defining a <code>iBGP</code> and if there are different we are defining a <code>eBGP</code>.</li>
</ul>
<p>For now, I have tried <code>OSPF</code> and <code>iBGP</code>. But I just simply follow the instruction and did not dig into the high-level setting.</p>
<p>is supported $\frac{1}{2}$</p>
</content>

<p>
  
  <a href="https://blog.cklau.cc/tags/networking/">#networking</a>
  
  <a href="https://blog.cklau.cc/tags/wireguard/">#wireguard</a>
  
  <a href="https://blog.cklau.cc/tags/experimental-network/">#experimental network</a>
  
</p>

  </main>
  <footer>


<p>
    <span><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">Á≤§ICPÂ§á2022102668Âè∑</a></span>

&copy; 2024 <a href="https://blog.cklau.cc">Junjie LIU</a>
    <a href="https://blog.cklau.cc/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
    <br>
Hosting and images served by <a href="https://cloud.tencent.com/">Tencent Cloud</a> / <a href="https://cloudflare.com/">Cloudflare</a> / <a href="https://webp.se/">WebP Cloud Services</a>
</p>

</footer>

    
</body>

</html>
