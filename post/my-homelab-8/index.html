<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="https://blog.cklau.cc/images/logo.svg" />
<title>ğŸ§‘ğŸ¿â€ğŸ’» Homelab: Cloudflare is All your Need, or Not | ç‰¹å€«è˜‡çš„æ—¥èˆ‡å¤œ</title>
<meta name="title" content="ğŸ§‘ğŸ¿â€ğŸ’» Homelab: Cloudflare is All your Need, or Not" />
<meta name="description" content="å›åˆ°åŸç‚¹ï¼Œåˆå¼€å§‹äº†ä¸€å¹´ä¸€åº¦çš„ Homelab æŠ˜è…¾ã€‚è¿™ä¸€æ¬¡ï¼Œ æ‰“ç®—æ•´ç‚¹ã€Œèµ·å¤œã€çº§æ–¹æ¡ˆ :)
åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåŠäº†ä¸€äº›ç½‘ç»œç›¸å…³çš„æ–¹æ¡ˆï¼Œæ¯”å¦‚å¦‚ä½•ä½¿ç”¨ Cloudflare Tunnel è¿›è¡Œâ€œè‡ªå»ºæœåŠ¡å…¨çƒåŠ é€Ÿâ€ã€‚å…¶ä¸­ï¼Œä¹ŸæåŠäº†å¯ä»¥è‡ªå»º GeoDNS è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘å°†è¯¦ç»†æè¿°å„ç§æ–¹æ¡ˆçš„å®è·µç»†èŠ‚ã€‚" />
<meta name="keywords" content="homelab,oauth2-proxy,nginx-ingress-controller,GeoDNS,Authoritative DNS,å®‰å…¨,é›¶ä¿¡ä»»,å­˜å‚¨,æƒå¨ DNS," />


<meta property="og:title" content="ğŸ§‘ğŸ¿â€ğŸ’» Homelab: Cloudflare is All your Need, or Not" />
<meta property="og:description" content="å›åˆ°åŸç‚¹ï¼Œåˆå¼€å§‹äº†ä¸€å¹´ä¸€åº¦çš„ Homelab æŠ˜è…¾ã€‚è¿™ä¸€æ¬¡ï¼Œ æ‰“ç®—æ•´ç‚¹ã€Œèµ·å¤œã€çº§æ–¹æ¡ˆ :)
åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåŠäº†ä¸€äº›ç½‘ç»œç›¸å…³çš„æ–¹æ¡ˆï¼Œæ¯”å¦‚å¦‚ä½•ä½¿ç”¨ Cloudflare Tunnel è¿›è¡Œâ€œè‡ªå»ºæœåŠ¡å…¨çƒåŠ é€Ÿâ€ã€‚å…¶ä¸­ï¼Œä¹ŸæåŠäº†å¯ä»¥è‡ªå»º GeoDNS è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘å°†è¯¦ç»†æè¿°å„ç§æ–¹æ¡ˆçš„å®è·µç»†èŠ‚ã€‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.cklau.cc/post/my-homelab-8/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2024-09-19T00:11:21+08:00" />
<meta property="article:modified_time" content="2024-09-19T00:11:21+08:00" />




<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="ğŸ§‘ğŸ¿â€ğŸ’» Homelab: Cloudflare is All your Need, or Not"/>
<meta name="twitter:description" content="å›åˆ°åŸç‚¹ï¼Œåˆå¼€å§‹äº†ä¸€å¹´ä¸€åº¦çš„ Homelab æŠ˜è…¾ã€‚è¿™ä¸€æ¬¡ï¼Œ æ‰“ç®—æ•´ç‚¹ã€Œèµ·å¤œã€çº§æ–¹æ¡ˆ :)
åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåŠäº†ä¸€äº›ç½‘ç»œç›¸å…³çš„æ–¹æ¡ˆï¼Œæ¯”å¦‚å¦‚ä½•ä½¿ç”¨ Cloudflare Tunnel è¿›è¡Œâ€œè‡ªå»ºæœåŠ¡å…¨çƒåŠ é€Ÿâ€ã€‚å…¶ä¸­ï¼Œä¹ŸæåŠäº†å¯ä»¥è‡ªå»º GeoDNS è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘å°†è¯¦ç»†æè¿°å„ç§æ–¹æ¡ˆçš„å®è·µç»†èŠ‚ã€‚"/>



<meta itemprop="name" content="ğŸ§‘ğŸ¿â€ğŸ’» Homelab: Cloudflare is All your Need, or Not">
<meta itemprop="description" content="å›åˆ°åŸç‚¹ï¼Œåˆå¼€å§‹äº†ä¸€å¹´ä¸€åº¦çš„ Homelab æŠ˜è…¾ã€‚è¿™ä¸€æ¬¡ï¼Œ æ‰“ç®—æ•´ç‚¹ã€Œèµ·å¤œã€çº§æ–¹æ¡ˆ :)
åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåŠäº†ä¸€äº›ç½‘ç»œç›¸å…³çš„æ–¹æ¡ˆï¼Œæ¯”å¦‚å¦‚ä½•ä½¿ç”¨ Cloudflare Tunnel è¿›è¡Œâ€œè‡ªå»ºæœåŠ¡å…¨çƒåŠ é€Ÿâ€ã€‚å…¶ä¸­ï¼Œä¹ŸæåŠäº†å¯ä»¥è‡ªå»º GeoDNS è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘å°†è¯¦ç»†æè¿°å„ç§æ–¹æ¡ˆçš„å®è·µç»†èŠ‚ã€‚"><meta itemprop="datePublished" content="2024-09-19T00:11:21+08:00" />
<meta itemprop="dateModified" content="2024-09-19T00:11:21+08:00" />
<meta itemprop="wordCount" content="1678">
<meta itemprop="keywords" content="homelab,oauth2-proxy,nginx-ingress-controller,GeoDNS,Authoritative DNS,å®‰å…¨,é›¶ä¿¡ä»»,å­˜å‚¨,æƒå¨ DNS," />
<meta name="referrer" content="no-referrer-when-downgrade" />

  <style>
  body {
    font-family: "Noto Serif SC", serif;
    font-weight: 500;
    font-style: normal;
    margin: auto;
    padding: 20px;
    max-width: 980px;
    text-align: left;
    background-color: #fff;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    color: #444;
  }

  h1,
  h2,
  h3,
  h4,
  h5,
  h6,
  strong,
  b {
    color: #222;
  }

  a {
    color: #444;
    text-decoration: none;
     
  }

  .title {
    text-decoration: none;
    border: 0;
  }

  .title span {
    font-weight: 400;
  }

  nav a {
    margin-right: 10px;
  }

  textarea {
    width: 100%;
    font-size: 16px;
  }

  input {
    font-size: 16px;
  }

  content {
    line-height: 1.6;
  }

  main content p a {
    word-wrap: break-word;
    border: none;
    box-shadow: inset 0 -2px #444;
    transition-property: box-shadow;
    transition-duration: .1s;
  }

  table {
    width: 100%;
  }

  img {
    max-width: 100%;
  }

  code {
    padding: 2px 5px;
    background-color: #f2f2f2;
  }

  pre code {
    color: #222;
    display: block;
    padding: 20px;
    white-space: pre-wrap;
    font-size: 14px;
    overflow-x: auto;
  }

  div.highlight pre {
    background-color: initial;
    color: initial;
  }

  div.highlight code {
    background-color: unset;
    color: unset;
  }

  blockquote {
    border-left: 1px solid #999;
    color: #222;
    padding-left: 20px;
    font-style: italic;
  }

  footer {
    padding: 25px;
    text-align: center;
  }

  .helptext {
    color: #777;
    font-size: small;
  }

  .errorlist {
    color: #eba613;
    font-size: small;
  }

   
  ul.blog-posts {
    list-style-type: none;
    padding: unset;
    line-height: 2;
  }

  ul.blog-posts li {
    display: flex;
  }

  ul.blog-posts li span {
    flex: 0 0 6.5rem;
  }

  ul.blog-posts li time {
    color: #8e8d8d;
  }

  ul.blog-posts li a:visited {
    color: #8b6fcb;
  }


   


  .bg { background-color: #f0f0f0; }
  .chroma { background-color: #f0f0f0; }
  .chroma .x {  }
  .chroma .err {  }
  .chroma .cl {  }
  .chroma .lnlinks { outline: none; text-decoration: none; color: inherit }
  .chroma .lntd { vertical-align: top; padding: 0; margin: 0; border: 0; }
  .chroma .lntable { border-spacing: 0; padding: 0; margin: 0; border: 0; }
  .chroma .hl { background-color: #ffffcc }
  .chroma .lnt { white-space: pre; user-select: none; margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
  .chroma .ln { white-space: pre; user-select: none; margin-right: 0.4em; padding: 0 0.4em 0 0.4em;color: #7f7f7f }
  .chroma .line { display: flex; }
  .chroma .k { color: #007020; font-weight: bold }
  .chroma .kc { color: #007020; font-weight: bold }
  .chroma .kd { color: #007020; font-weight: bold }
  .chroma .kn { color: #007020; font-weight: bold }
  .chroma .kp { color: #007020 }
  .chroma .kr { color: #007020; font-weight: bold }
  .chroma .kt { color: #902000 }
  .chroma .n {  }
  .chroma .na { color: #4070a0 }
  .chroma .nb { color: #007020 }
  .chroma .bp {  }
  .chroma .nc { color: #0e84b5; font-weight: bold }
  .chroma .no { color: #60add5 }
  .chroma .nd { color: #555555; font-weight: bold }
  .chroma .ni { color: #d55537; font-weight: bold }
  .chroma .ne { color: #007020 }
  .chroma .nf { color: #06287e }
  .chroma .fm {  }
  .chroma .nl { color: #002070; font-weight: bold }
  .chroma .nn { color: #0e84b5; font-weight: bold }
  .chroma .nx {  }
  .chroma .py {  }
  .chroma .nt { color: #062873; font-weight: bold }
  .chroma .nv { color: #bb60d5 }
  .chroma .vc {  }
  .chroma .vg {  }
  .chroma .vi {  }
  .chroma .vm {  }
  .chroma .l {  }
  .chroma .ld {  }
  .chroma .s { color: #4070a0 }
  .chroma .sa { color: #4070a0 }
  .chroma .sb { color: #4070a0 }
  .chroma .sc { color: #4070a0 }
  .chroma .dl { color: #4070a0 }
  .chroma .sd { color: #4070a0; font-style: italic }
  .chroma .s2 { color: #4070a0 }
  .chroma .se { color: #4070a0; font-weight: bold }
  .chroma .sh { color: #4070a0 }
  .chroma .si { color: #70a0d0 }
  .chroma .sx { color: #c65d09 }
  .chroma .sr { color: #235388 }
  .chroma .s1 { color: #4070a0 }
  .chroma .ss { color: #517918 }
  .chroma .m { color: #40a070 }
  .chroma .mb { color: #40a070 }
  .chroma .mf { color: #40a070 }
  .chroma .mh { color: #40a070 }
  .chroma .mi { color: #40a070 }
  .chroma .il { color: #40a070 }
  .chroma .mo { color: #40a070 }
  .chroma .o { color: #666666 }
  .chroma .ow { color: #007020; font-weight: bold }
  .chroma .p {  }
  .chroma .c { color: #60a0b0; font-style: italic }
  .chroma .ch { color: #60a0b0; font-style: italic }
  .chroma .cm { color: #60a0b0; font-style: italic }
  .chroma .c1 { color: #60a0b0; font-style: italic }
  .chroma .cs { color: #60a0b0; background-color: #fff0f0 }
  .chroma .cp { color: #007020 }
  .chroma .cpf { color: #007020 }
  .chroma .g {  }
  .chroma .gd { color: #a00000 }
  .chroma .ge { font-style: italic }
  .chroma .gr { color: #ff0000 }
  .chroma .gh { color: #000080; font-weight: bold }
  .chroma .gi { color: #00a000 }
  .chroma .go { color: #888888 }
  .chroma .gp { color: #c65d09; font-weight: bold }
  .chroma .gs { font-weight: bold }
  .chroma .gu { color: #800080; font-weight: bold }
  .chroma .gt { color: #0044dd }
  .chroma .gl { text-decoration: underline }
  .chroma .w { color: #bbbbbb }


 
.sidenote {
    font-size: 80%;         
    font-weight: normal;
    color: var(--theme-hl1-color);
    position: relative;     
}
 
@media (min-width: 1400px) {
    .sidenote {
        float: right;
        clear: right;            
        text-align: left;

         
            
        top: -3rem;             
        width: 20vw;            
        margin-right: -23vw;     
        margin-top: 1rem;       
    }
}
 
 
@media (max-width: 1400px) {
    .sidenote {
         
        float: right;
        text-align: left;

            
        width: 100%;  
        margin: 1rem 0;
        padding-left: 5%;  
    }
}
 
 
body {
    counter-reset: sidenote-counter;
}
.sidenote-number {
    counter-increment: sidenote-counter;
}
 
.sidenote::before {
    content: "\2020";
    position: relative;
    vertical-align: super;
    font-size: 0.9em;
    font-weight: bold;
}
 
.sidenote-number::after {
    content: "\2020";
    position: relative;
    vertical-align: super;
    font-size: 0.7em;
    font-weight: bold;
    color: var(--theme-body-color);
    display: inline;
    margin-right: 0.2rem;
}
@media (min-width: 1400px) {
     
    .sidenote-number:hover .sidenote {
        background-color: var(--theme-color-light);
    }
}

  
.card-container {
    display: flex;
    flex-direction: column;
    align-items: center;  
    gap: 5px;  
    padding: 5px;
}

.card {
    width: 80%;  
    box-shadow: 0 0px 0px rgba(0,0,0,0.1);  
    display: flex;
    align-items: center;  
    padding: 10px;
    background: white;  
    text-decoration: none;  
    color: inherit;  
}

.card img {
    width: 80px;  
    height: 80px;
    border-radius: 50%;  
    margin-right: 20px;  
}

.card .info h2 {
    margin: 0;
    font-size: 1.2em;  
}

.card .info p {
    margin: 5px 0 0;  
    font-size: 0.9em;
    color: #444;  
}
.card .info span{
    font-size: 0.5em;
    color: #666;
}
</style>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500&display=swap" rel="stylesheet">
<script defer data-domain="nova.moe" src="https://possible.knat.network/js/script.js"></script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1844674035384472" crossorigin="anonymous"></script>
<link rel="alternate" type="application/rss+xml" href="https://blog.cklau.cc/feed.xml" title="ç‰¹å€«è˜‡çš„æ—¥èˆ‡å¤œ">

</head>

<body>
  <header><a href="/" class="title">
  <h2>ç‰¹å€«è˜‡çš„æ—¥èˆ‡å¤œ</h2>
</a>
<nav><a href="/">Home</a>

<a href="/post">[Blog]</a>

<a href="/post/scientia">[Scientia]</a>

<a href="/links">[Links]</a>

</nav>
</header>
  <main>
<h1>ğŸ§‘ğŸ¿â€ğŸ’» Homelab: Cloudflare is All your Need, or Not</h1>
<p>
  <i>
    <time datetime='2024-09-19' pubdate>
      19 Sep, 2024
    </time>
  </i>
</p>

<content>
  <p>å›åˆ°åŸç‚¹ï¼Œåˆå¼€å§‹äº†ä¸€å¹´ä¸€åº¦çš„ Homelab æŠ˜è…¾ã€‚è¿™ä¸€æ¬¡ï¼Œ æ‰“ç®—æ•´ç‚¹ã€Œèµ·å¤œã€çº§æ–¹æ¡ˆ :)</p>
<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåŠäº†ä¸€äº›ç½‘ç»œç›¸å…³çš„æ–¹æ¡ˆï¼Œæ¯”å¦‚å¦‚ä½•ä½¿ç”¨ Cloudflare Tunnel è¿›è¡Œâ€œè‡ªå»ºæœåŠ¡å…¨çƒåŠ é€Ÿâ€ã€‚å…¶ä¸­ï¼Œä¹ŸæåŠäº†å¯ä»¥è‡ªå»º GeoDNS è¾¾åˆ°ç±»ä¼¼çš„æ•ˆæœï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘å°†è¯¦ç»†æè¿°å„ç§æ–¹æ¡ˆçš„å®è·µç»†èŠ‚ã€‚</p>
<h2 id="è‡ªå»º-geodns-ä»¥æ‘†è„±-cloudflare-å„æ–­">è‡ªå»º GeoDNS ä»¥æ‘†è„± Cloudflare å„æ–­</h2>
<p>GeoDNS æ˜¯ä¸€ç§åŸºäºè¯·æ±‚ä½ç½®çš„æµé‡åˆ†é…è¿‡ç¨‹ï¼Œé€šè¿‡åˆ¤æ–­è¯·æ±‚ IP çš„åœ°ç†ä½ç½®ï¼Œåˆ†é…ç¦»ä»–æœ€è¿‘çš„å‡ºå£ IP ä»¥è¾¾åˆ°åŸºäºåœ°ç†è·¯ç”±çš„æµé‡ä¼˜åŒ–ã€‚è¯´äººè¯å°±æ˜¯å„ä¸ªå¤§æ´²åˆ†åˆ«ä¸€ä¸ª IPã€‚ä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œè°ä¼šæä¾›è¿™ç§çœ‹èµ·æ¥å°±å¾ˆå¥½çš„æœåŠ¡å‘¢ï¼Ÿèµ›åšè©è¨è¡¨ç¤ºï¼Œæˆ‘ä»¬ Anycast èµ·å®¶ï¼Œå¤©ç„¶æ— æ³•æä¾› GeoDNSã€‚å› ä¸ºå¯¹äº Anycast DNS æ¥è¯´ï¼Œä»–ä»¬ä¼šå°†ä¸€ä¸ª IP é€šè¿‡ BGP çš„æ–¹å¼åœ¨å¤šåœ°å®£å‘Šï¼Œé‚£ä¹ˆå¯¹äºç”¨æˆ·æ¥è¯´ï¼Œèƒ½å¦åˆ°è¾¾ç¦»ä»–ä»¬æœ€è¿‘çš„ IP å°±å–å†³äºæœ¬åœ°ç½‘ç»œæä¾›å•†çš„æ¥å…¥æƒ…å†µå’Œä»‹å…¥æƒ…å†µã€‚ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šå¦‚æœå½“åœ°ç½‘ç»œæœåŠ¡å•†åŸºäºä¸€äº›åŸå› ï¼ˆä¾‹å¦‚å®‰å…¨å’Œå†…å®¹åˆè§„ç­‰åŸå› ï¼‰å°† CDN æä¾›å•†çš„ IP æ®µè¿›è¡Œè·¯ç”±çº§åˆ«çš„åŠ£åŒ–ï¼Œåˆ™æ— è®º CDN æä¾›å•†å¤šä¹ˆçš„åŠªåŠ›ï¼Œä¹Ÿæ— æ³•è¾¾åˆ°åŠ é€Ÿçš„ç›®çš„ã€‚ä»è®¡ç®—æœºç½‘ç»œæ¥è¯´ï¼ŒAnycast çš„å®ç°æ˜¯åœ¨ç½‘ç»œå±‚ï¼Œè€Œ GeoDNS æ˜¯åœ¨åº”ç”¨å±‚ï¼Œæ‰€ä»¥ Anycast ä¸çŸ¥é“è¯·æ±‚è€…çš„ IP ä½ç½®ï¼Œæ‰€ä»¥ä¼šå‡ºç°è¿™æ ·çš„æƒ…å†µï¼šè™½ç„¶åœ¨ DNS çœ‹æ¥è¿™ä¸ªè¯·æ±‚æ›´åŠ æ¥è¿‘æŸåœ°çš„æœåŠ¡å™¨ï¼Œä½†å®é™…ä¸Šè¿™ä¸ª CDN ç«™ç‚¹ç¦»åŸç«™æ›´è¿œã€‚</p>
<p>åŸºäºä»¥ä¸Šçš„å‡ ç‚¹ï¼Œæˆ‘é€‰æ‹©æ­å»º GeoDNS æ¥æ›¿ä»£ Cloudflare çš„ Anycast<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>ã€‚</p>
<h3 id="æƒå¨-dns-çš„å®‰è£…ä¸é…ç½®authoritative-dns">æƒå¨ DNS çš„å®‰è£…ä¸é…ç½®ï¼ˆAuthoritative DNSï¼‰</h3>
<h4 id="å‰æ">å‰æ</h4>
<p>ç°å­˜æœ‰ä¸å°‘å¼€æºæƒå¨ DNS è½¯ä»¶å¯ä»¥é€‰æ‹©ï¼Œæ¯”å¦‚ Bind9/PowerDNS ç­‰ç­‰ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©ä½¿ç”¨ PowerDNSï¼ŒåŸå› æ˜¯å› ä¸ºä»–æœ‰ pdns-admin å¯ä»¥è®©æˆ‘è¿›è¡Œ web ç®¡ç†ï¼Œè€Œä¸æ˜¯é¢å¯¹å„ç§é…ç½®æ–‡ä»¶ï¼Œ åŒæ—¶å®ƒæ˜¯ä½¿ç”¨æ•°æ®åº“è¿›è¡Œ DNS çºªå½•å­˜å‚¨ï¼Œè€Œä¸æ˜¯è·Ÿ BIND9 ä¸€æ ·çš„æ–‡æœ¬å­˜å‚¨ï¼Œæ›´åŠ é€‚åˆé«˜å¯ç”¨ã€‚å› ä¸ºæ¶‰åŠåˆ°é«˜å¯ç”¨ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦å‡†å¤‡ä¸¤å° VPSï¼Œæˆ‘é€‰æ‹©äº†ä¸€å°é¦™æ¸¯çš„æœåŠ¡å™¨å’Œä¸€å°çº½çº¦çš„æœåŠ¡å™¨ä½œä¸º ns1 å’Œ ns2ã€‚åŒæ—¶ï¼Œé™¤äº†éœ€è¦ä½¿ç”¨çš„åŸŸåï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªé¢å¤–çš„åŸŸååˆ†é…ç»™ DNS æœåŠ¡å™¨ï¼Œæ‰€ä»¥ï¼ŒåŸºç¡€å‡†å¤‡å¦‚ä¸‹<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>ï¼š</p>
<table>
<thead>
<tr>
<th>åŸŸå</th>
<th>IPV4</th>
<th>IPV6</th>
</tr>
</thead>
<tbody>
<tr>
<td>ns1.example.dns</td>
<td>191.103.113.114</td>
<td>79cc:5f8f:47b1:963e:d248:70ea:0186:b842</td>
</tr>
<tr>
<td>ns2.example.dns</td>
<td>31.84.179.51</td>
<td>9c7d:f2b6:1777:1904:fcfc:3a24:cccd:c0a6</td>
</tr>
<tr>
<td><a href="https://www.example.com">www.example.com</a></td>
<td>249.209.110.226,160.38.17.187,66.167.146.39</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<p>åœ¨æ­å»ºæƒå¨ DNS æœåŠ¡å™¨çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬å¸¸å¸¸å¬è¯´ä¸€ä¸ªè¯å«åšèƒ¶æ°´çºªå½• - Glue Recordï¼Œè¿™ä¸ªçºªå½•ä¹Ÿæ˜¯ä¸€ç§ DNS çºªå½•ï¼Œä½†æ˜¯ä¿å­˜åœ¨åŸŸåæ³¨å†Œå±€çš„ DNS æœåŠ¡å™¨ä¸Šï¼Œä¾‹å¦‚æŸ¥è¯¢ <code>www.example.com</code> çš„ çºªå½•æ—¶ï¼Œè¿™ä¸ªè¯·æ±‚é¦–å…ˆå»åˆ°é€’å½’ DNS æœåŠ¡å™¨ <code>R</code>ï¼Œ ç„¶å <code>R</code> å†å»è¯¢é—®å¯¹åº”çš„ DNS æ ¹æœåŠ¡å™¨ <code>A0</code>ï¼Œ å½“ç„¶ï¼Œ<code>A0</code> å¹¶ä¸å­˜æ”¾æ‰€æœ‰çš„çºªå½•ï¼Œä»–åªä¼šå‘Šè¯‰ <code>R</code> å¯¹åº”çš„åŸŸå <code>example.com</code> åº”è¯¥å»å¯¹åº”çš„æƒå¨æœåŠ¡å™¨ <code>A1</code> è¿›è¡ŒæŸ¥è¯¢ã€‚ æ‰€ä»¥ï¼Œèƒ¶æ°´çºªå½•å®é™…ä¸Šå°±æ˜¯ <code>A0</code> åˆ° <code>A1</code> çš„æŒ‡å‘ã€‚è€Œæ‰€æœ‰çš„æ ¹æœåŠ¡å™¨éƒ½å¯ä»¥åˆ° <a href="https://www.iana.org/domains/root/servers">IANA</a> æŸ¥åˆ°ï¼Œ å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ <code>dig</code> æŸ¥åˆ°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">(</span>base<span style="color:#f92672">)</span> <span style="color:#f92672">{}</span> ~ dig com. NS + short
</span></span><span style="display:flex;"><span>;; Invalid option
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; com. NS + short
</span></span><span style="display:flex;"><span>;; global options: +cmd
</span></span><span style="display:flex;"><span>;; Got answer:
</span></span><span style="display:flex;"><span>;; -&gt;&gt;HEADER<span style="color:#e6db74">&lt;&lt;- opcode: QUERY, status: NOERROR, id: 25108
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;; flags: qr rd ra; QUERY: 1, ANSWER: 13, AUTHORITY: 0, ADDITIONAL: 1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;; OPT PSEUDOSECTION:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">; EDNS: version: 0, flags:; udp: 1220
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;; QUESTION SECTION:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;com.				IN	NS
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;; ANSWER SECTION:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">com.			35830	IN	NS	h.gtld-servers.net.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">com.			35830	IN	NS	f.gtld-servers.net.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">com.			35830	IN	NS	k.gtld-servers.net.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">com.			35830	IN	NS	b.gtld-servers.net.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">com.			35830	IN	NS	c.gtld-servers.net.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">com.			35830	IN	NS	g.gtld-servers.net.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">com.			35830	IN	NS	d.gtld-servers.net.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">com.			35830	IN	NS	m.gtld-servers.net.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">com.			35830	IN	NS	a.gtld-servers.net.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">com.			35830	IN	NS	j.gtld-servers.net.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">com.			35830	IN	NS	e.gtld-servers.net.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">com.			35830	IN	NS	i.gtld-servers.net.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">com.			35830	IN	NS	l.gtld-servers.net.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;; Query time: 15 msec
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;; SERVER: 192.168.1.1#53(192.168.1.1)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;; WHEN: Thu Sep 26 13:43:28 IST 2024
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;; MSG SIZE  rcvd: 256
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;; Got answer:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">;; -&gt;&gt;HEADER&lt;&lt;- opcode</span>: QUERY, status: NXDOMAIN, id: <span style="color:#ae81ff">48582</span>
</span></span><span style="display:flex;"><span>;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; OPT PSEUDOSECTION:
</span></span><span style="display:flex;"><span>; EDNS: version: 0, flags:; udp: <span style="color:#ae81ff">4096</span>
</span></span><span style="display:flex;"><span>;; QUESTION SECTION:
</span></span><span style="display:flex;"><span>;short.				IN	A
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>;; Query time: <span style="color:#ae81ff">5</span> msec
</span></span><span style="display:flex;"><span>;; SERVER: 192.168.1.1#53<span style="color:#f92672">(</span>192.168.1.1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>;; WHEN: Thu Sep <span style="color:#ae81ff">26</span> 13:43:28 IST <span style="color:#ae81ff">2024</span>
</span></span><span style="display:flex;"><span>;; MSG SIZE  rcvd: <span style="color:#ae81ff">34</span>
</span></span></code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>.com</code>è¿™ä¸ªåŸŸåæ˜¯åœ¨ <code>a.gtld-servers.net.</code> åˆ° <code>l.gtld-servers.net.</code> è¿™äº› DNS æ ¹æœåŠ¡å™¨è¿›è¡Œçºªå½•ã€‚å½“ç„¶ï¼Œè¿™é‡Œæ‰¯è¿œäº†ï¼Œè¿˜æ˜¯å›åˆ°èƒ¶æ°´çºªå½•ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒåŸŸåæ³¨å†Œå•†çš„ç½‘ç«™éƒ½å¯ä»¥æ·»åŠ èƒ¶æ°´çºªå½•ï¼Œè€Œæœ‰çš„æ³¨å†Œå•†åˆ™æ˜¯éœ€è¦ä»˜è´¹æ‰èƒ½æ·»åŠ ï¼Œè¿™å–å†³äºä½ çš„æœåŠ¡æä¾›å•†ã€‚åŒæ—¶ï¼Œæœ‰çš„æ³¨å†Œå•†å¹¶æ²¡æœ‰ä½¿ç”¨ ã€Œèƒ¶æ°´çºªå½•ã€è¿™ä¸ªè¯ï¼Œè€Œæ˜¯ä½¿ç”¨ ã€Œæ³¨å†Œ DNS æœåŠ¡å™¨ã€æˆ–è€… ã€ŒDNS Hostã€ï¼Œä¾‹å¦‚æˆ‘ä½¿ç”¨çš„<a href="https://cloud.tencent.com/document/product/242/54158">è…¾è®¯äº‘</a>å°±æ˜¯ç§°ä½œ ã€ŒDNS Hostã€å¦‚ä¸‹å›¾ï¼š</p>
<center>
    <img src="https://32cf906.webp.li/2024/09/dns-dnspod.png" width="70%" alt="DNS èƒ¶æ°´çºªå½•">
</center>
<p>åœ¨å®Œæˆä»¥åï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°† <code>exmaple.dns</code> çš„ NS æœåŠ¡å™¨æ”¹ä¸º <code>ns1.example.dns</code> å’Œ <code>ns2.example.dns</code><sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>ã€‚</p>
<h4 id="å®‰è£…-powerdns-å’Œ-mariadb-ä¸-powerdns-åˆå§‹é…ç½®">å®‰è£… PowerDNS å’Œ MariaDB ä¸ PowerDNS åˆå§‹é…ç½®</h4>
<p>æˆ‘ä»¬éœ€è¦åœ¨ä¸¤å°æœåŠ¡å™¨ä¸Šéƒ½å®‰è£… PowerDNS å’Œ MariaDBï¼Œè¿™é‡Œï¼Œæˆ‘è®© NS1 ä½œä¸ºä¸»è¦èŠ‚ç‚¹è€Œ NS2 ä½œä¸ºå¤‡ä»½èŠ‚ç‚¹ (ä¸¤å°æœåŠ¡å™¨å‡ä½¿ç”¨ Debian 12)ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo su
</span></span><span style="display:flex;"><span>apt-get update <span style="color:#f92672">&amp;&amp;</span> apt-get upgrade -y 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># å¯¼å…¥ PowerDNS å’Œ MariaDB å®˜æ–¹æºå’Œç­¾å å¹¶ å®‰è£…</span>
</span></span><span style="display:flex;"><span>curl -sSL https://repo.powerdns.com/FD380FBB-pub.asc | gpg --dearmor &gt; /usr/share/keyrings/powerdns.gpg
</span></span><span style="display:flex;"><span>cat &gt; /etc/apt/sources.list.d/pdns.list <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/powerdns.gpg] http://repo.powerdns.com/debian $(lsb_release -sc)-auth-49 main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/powerdns.gpg] http://repo.powerdns.com/debian $(lsb_release -sc)-rec-50 main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/powerdns.gpg] http://repo.powerdns.com/debian $(lsb_release -sc)-dnsdist-19 main
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## ä¼˜å…ˆä½¿ç”¨ PowerDNS å®˜æ–¹æºè¿›è¡Œå®‰è£…</span>
</span></span><span style="display:flex;"><span>cat &gt;&gt; /etc/apt/preferences.d/pdns <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Package: pdns-*
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Pin: origin repo.powerdns.com
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Pin-Priority: 600
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>curl -sSL https://mariadb.org/mariadb_release_signing_key.asc | gpg --dearmor &gt; /usr/share/keyrings/mariadb.gpg
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;deb [arch=</span><span style="color:#66d9ef">$(</span>dpkg --print-architecture<span style="color:#66d9ef">)</span><span style="color:#e6db74"> signed-by=/usr/share/keyrings/mariadb.gpg] https://mirror-cdn.xtom.com/mariadb/repo/11.4/debian </span><span style="color:#66d9ef">$(</span>lsb_release -sc<span style="color:#66d9ef">)</span><span style="color:#e6db74"> main&#34;</span> &gt; /etc/apt/sources.list.d/mariadb.list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## éœ€è¦å®‰è£… geoip æ’ä»¶ï¼Œä¸ºåç»­é…ç½® geodns åšå‡†å¤‡</span>
</span></span><span style="display:flex;"><span>apt-get update <span style="color:#f92672">&amp;&amp;</span> apt-get install pdns-server pdns-backend-mysql pdns-backend-geoip mariadb-server 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## é…ç½®æ•°æ®åº“åŒæ­¥</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### åœ¨ NS1 é‡Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</span>
</span></span><span style="display:flex;"><span>mkdir /var/lib/mysql-bin
</span></span><span style="display:flex;"><span>chown mysql:mysql /var/lib/mysql-bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/mysql/mariadb.conf.d/61-master.cnf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mysqld]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">skip-host-cache
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">skip-name-resolve
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">bind-address = 0.0.0.0 # ä¹Ÿå¯ä»¥ä¿®æ”¹ä¸ºå…¶ä»– NS2 å¯ä»¥è®¿é—®åˆ°çš„ NS1 çš„ IP 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server-id = $SRANDOM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">log-bin = /var/lib/mysql-bin/binlog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expire_logs_days = 7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### é€šè¿‡ iptables é™åˆ¶ 3306 çš„è®¿é—®</span>
</span></span><span style="display:flex;"><span>iptables -I INPUT -p tcp --dport <span style="color:#ae81ff">3306</span> -j DROP
</span></span><span style="display:flex;"><span>iptables -I INPUT -s 127.0.0.1 -p tcp --dport <span style="color:#ae81ff">3306</span> -j ACCEPT 
</span></span><span style="display:flex;"><span>iptables -I INPUT -s &lt;NS2 çš„ IP æˆ–è€…å…¶ä»–æŒ‡å®š IP æ®µ&gt; -p tcp --dport <span style="color:#ae81ff">3306</span> -j ACCEPT  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### æ–°å»ºä¸€ä¸ª backup ç”¨æˆ·ï¼Œä½¿å¾— NS2 å¯ä»¥è®¿é—® NS1 æ‰€æœ‰æ•°æ®åº“</span>
</span></span><span style="display:flex;"><span>mariadb -e <span style="color:#e6db74">&#34;GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* to &#39;backup&#39;@&#39;%&#39; identified by &#39;backup_pass&#39;;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### é‡å¯ MariaDB å¹¶æŸ¥çœ‹è¿è¡Œæƒ…å†µ</span>
</span></span><span style="display:flex;"><span>systemctl restart mariadb
</span></span><span style="display:flex;"><span>systemctl status mariadb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### åœ¨ NS2 é‡Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</span>
</span></span><span style="display:flex;"><span>mkdir /var/lib/mysql-bin
</span></span><span style="display:flex;"><span>chown mysql:mysql /var/lib/mysql-bin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat &gt; /etc/mysql/mariadb.conf.d/61-slave.cnf <span style="color:#e6db74">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[mysqld]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">skip-host-cache
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">skip-name-resolve
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">server-id = $SRANDOM
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">relay-log = /var/lib/mysql-bin/relaylog
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">expire_logs_days = 7
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sed -i <span style="color:#e6db74">&#39;s/expire_logs_days/#expire_logs_days/g&#39;</span> /etc/mysql/mariadb.conf.d/50-server.cnf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### ä»…å…è®¸æœ¬æœºè®¿é—® 3306</span>
</span></span><span style="display:flex;"><span>iptables -I INPUT -p tcp --dport <span style="color:#ae81ff">3306</span> -j DROP
</span></span><span style="display:flex;"><span>iptables -I INPUT -s 127.0.0.1 -p tcp --dport <span style="color:#ae81ff">3306</span> -j ACCEPT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### é‡å¯ MariaDB å¹¶æŸ¥çœ‹è¿è¡Œæƒ…å†µ</span>
</span></span><span style="display:flex;"><span>systemctl restart mariadb
</span></span><span style="display:flex;"><span>systemctl status mariadb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### æ£€æŸ¥ NS1 å’Œ NS2 ä¸¤å°æœåŠ¡å™¨çš„æ•°æ®åº“</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### åœ¨ NS1 ä¸­è¿è¡Œ</span>
</span></span><span style="display:flex;"><span>mariadb -e <span style="color:#e6db74">&#34;show binary logs;\G&#34;</span> <span style="color:#75715e"># å¦‚å‡ºç° binlog.000001 å’Œ file size ä¸º 325 åˆ™æ­£å¸¸ï¼ˆæ–°å®‰è£…çš„æƒ…å†µä¸‹ï¼‰</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### åœ¨ NS2 ä¸­è¿è¡Œ</span>
</span></span><span style="display:flex;"><span>mariadb -e <span style="color:#e6db74">&#34;CHANGE MASTER TO MASTER_HOST=&#39;&lt;NS1-IP ADDR&gt;&#39;, MASTER_USER=&#39;backup&#39;, MASTER_PASSWORD=&#39;backup_pass&#39;, MASTER_PORT=3306, MASTER_LOG_FILE=&#39;binlog.000001&#39;, MASTER_LOG_POS=325; START SLAVE; SHOW SLAVE STATUS\G&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">### å¯¼å…¥ PowerDNS æ•°æ®åº“</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### åœ¨ NS1 ä¸­è¿è¡Œ</span>
</span></span><span style="display:flex;"><span>mariadb -u root
</span></span><span style="display:flex;"><span>CREATE DATABASE pdns_database DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci; 
</span></span><span style="display:flex;"><span>GRANT ALL ON pdns_database.* TO <span style="color:#e6db74">&#39;pdns_user&#39;</span>@<span style="color:#e6db74">&#39;%&#39;</span> IDENTIFIED BY <span style="color:#e6db74">&#39;pdns_password&#39;</span>; <span style="color:#75715e"># pdns_user å’Œ pdns_password æ˜¯ PowerDNS æ•°æ®åº“çš„ç”¨æˆ·åå’Œå¯†ç </span>
</span></span><span style="display:flex;"><span>FLUSH PRIVILEGES; 
</span></span><span style="display:flex;"><span>EXIT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cd /usr/share/pdns-backend-mysql/schema
</span></span><span style="display:flex;"><span>mariadb -u pdns_user --default-character-set<span style="color:#f92672">=</span>utf8mb4 -p pdns_database &lt; schema.mysql.sql
</span></span><span style="display:flex;"><span>mariadb -u pdns_user --default-character-set<span style="color:#f92672">=</span>utf8mb4 -p pdns_database &lt; enable-foreign-keys.mysql.sql
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### åœ¨ NS2 ä¸­è¿è¡Œ</span>
</span></span><span style="display:flex;"><span>mariadb -e <span style="color:#e6db74">&#34;show databases;\G&#34;</span>  <span style="color:#75715e"># å¦‚å·²ç»åŒæ­¥ pdns_database åˆ™ä¸ºæ­£å¸¸</span>
</span></span></code></pre></div><p>åœ¨å®Œæˆæ•°æ®åº“è®¾ç½®åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹å¯¹ PowerDNS è¿›è¡Œåˆå§‹åŒ–é…ç½®ï¼Œé¦–å…ˆåˆ é™¤é»˜è®¤å®‰è£…çš„ <code>/etc/powerdns/pdns.d/bind.conf</code>, ç„¶åæ·»åŠ ä¸€ä¸ª <code>/etc/powerdns/pdns.d/dns.conf</code> å¹¶è¾“å…¥ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat &gt;&gt; /etc/powerdns/pdns.d/dns.conf <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">launch=gmysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gmysql-host=localhost
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gmysql-user=pdns_user # æ•°æ®åº“ç”¨æˆ·å
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gmysql-dbname=pdns_database # æ•°æ®åº“å
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gmysql-password=pdns_password # æ•°æ®åº“å¯†ç 
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gmysql-dnssec=yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">default-soa-content=ns1.example.dns hostmaster.example.dns 0 3600 14400 604800 3600
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">api=yes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">api-key=random_api_key # api key å¯ä»¥éšæ„æ›´æ¢ï¼Œæ¯”å¦‚ä½¿ç”¨ openssl ç”Ÿæˆï¼šopenssl rand -base64 16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">local-address=0.0.0.0 ::
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">local-port=53
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">webserver-address=0.0.0.0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">webserver-allow-from=127.0.0.1, ::1, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">webserver-port=8081
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>åœ¨å®Œæˆé…ç½®åï¼Œéœ€è¦é‡å¯ PowerDNSï¼š<code>systemctl restart pdns</code>ï¼Œä½†æ˜¯åœ¨é‡å¯ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ° PowerDNS å ç”¨å¾—æ˜¯ <code>53</code> ç«¯å£ï¼Œä½†æ˜¯é»˜è®¤æƒ…å†µä¸‹ï¼ŒDebian/Ubuntu éƒ½ä¼šè¢«ç³»ç»Ÿçš„ <code>systemd-resolved</code> å ç”¨, æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å…³é—­å®ƒï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ä»…é’ˆå¯¹ Debian 11/12ï¼Œå…¶ä»–ç³»ç»Ÿè¯·å‚è€ƒå¯¹åº”ç³»ç»Ÿçš„æ•™ç¨‹</span>
</span></span><span style="display:flex;"><span>sudo su 
</span></span><span style="display:flex;"><span>systemctl stop systemd-resolved <span style="color:#f92672">&amp;&amp;</span> systemctl disable systemd-resolved
</span></span><span style="display:flex;"><span>cp /etc/resolv.conf /etc/resolv.conf.bak <span style="color:#f92672">&amp;&amp;</span> rm -rf /etc/resolv.conf
</span></span><span style="display:flex;"><span>cat &gt;&gt; /etc/resolv.conf <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">nameserver  1.1.1.1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">nameserver  8.8.8.8
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>systemctl restart networking
</span></span></code></pre></div><h4 id="powerdns-admin-å®‰è£…">PowerDNS-Admin å®‰è£…</h4>
<p><a href="https://github.com/PowerDNS-Admin/PowerDNS-Admin">PowerDNS Admin</a> æ˜¯ä¸€ä¸ªåŸºäº Django çš„ PowerDNS ç®¡ç†è½¯ä»¶ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¼šå•ç‹¬éƒ¨ç½²è€Œä¸æ˜¯éƒ¨ç½²åœ¨ NS1 æˆ–è€… NS2 ä¸Šã€‚GitHub ä¸Šæœ‰å¯¹åº”çš„ Docker å’Œæœ¬åœ°å®‰è£…æ•™ç¨‹ï¼Œè¿™é‡Œï¼Œæˆ‘å·² K3s/K8s ä¸ºä¾‹ï¼š</p>
<p>é¦–å…ˆåˆ›å»º namespaceï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">powerdns</span>
</span></span></code></pre></div><p>ç„¶ååˆ›å»º PV å’Œ PVCï¼Œè¿™æ˜¯ä¸ºäº†æŒä¹…åŒ–å­˜å‚¨æ•°æ®åº“ä¸Šçš„æ•°æ®ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>local-host</code> çš„å­˜å‚¨æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–çš„å­˜å‚¨åç«¯ï¼Œæ¯”å¦‚ NFS æˆ–è€… Cephï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pdns-pv</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">10Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">local-storage</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/data/pdns</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeAffinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelectorTerms</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">kubernetes.io/hostname</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">base-server</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolume</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pdns-mysql-pv</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">capacity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">10Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">persistentVolumeReclaimPolicy</span>: <span style="color:#ae81ff">Retain</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">local-storage</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/data/pdns</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">nodeAffinity</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">required</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeSelectorTerms</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">matchExpressions</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">key</span>: <span style="color:#ae81ff">kubernetes.io/hostname</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">operator</span>: <span style="color:#ae81ff">In</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">values</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#ae81ff">base-server</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pdns-pvc</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">powerdns</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">10Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">local-storage</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeName</span>: <span style="color:#ae81ff">pdns-pv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PersistentVolumeClaim</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pdns-mysql-pvc</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">powerdns</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">accessModes</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">ReadWriteMany</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">requests</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">storage</span>: <span style="color:#ae81ff">10Gi</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">storageClassName</span>: <span style="color:#ae81ff">local-storage</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">volumeName</span>: <span style="color:#ae81ff">pdns-mysql-pv</span>
</span></span></code></pre></div><p>éšååˆ›å»º <code>Deployment</code>, <code>Serivce</code> å’Œ <code>Ingress</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">powerdns</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">powerdns</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">powerdns</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">powerdns</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodeName</span>: <span style="color:#ae81ff">base-server</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">powerdns</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">powerdnsadmin/pda-legacy:latest</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SECRET_KEY</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;&lt;random-secret-key&gt;&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SQLALCHEMY_DATABASE_URI</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;mysql://powerdns-admin-user:powerdns-admin-password@127.0.0.1/powerdns-admin-database&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">GUNICORN_TIMEOUT</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;60&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">GUNICORN_WORKERS</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;4&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">GUNICORN_LOGLEVEL</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;DEBUG&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">OFFLINE_MODE</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;False&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pdns-pvc</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/data</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">powerdns-admin-mariadb</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mariadb:11.4</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">3306</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_ROOT_PASSWORD</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;mysql_root_password&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_DATABASE</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;powerdns-admin-database&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_USER</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;powerdns-admin-user&#34;</span>
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">MYSQL_PASSWORD</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#34;powerdns-admin-password&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">volumeMounts</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pdns-mysql-pvc</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/var/lib/mysql</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">volumes</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pdns-pvc</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">pdns-pvc</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pdns-mysql-pvc</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">persistentVolumeClaim</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">claimName</span>: <span style="color:#ae81ff">pdns-mysql-pvc</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">powerdns</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">powerdns</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">powerdns</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-pdns</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">powerdns</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">pdns.example.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">powerdns</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><p>æ³¨å†Œçš„ç¬¬ä¸€ä¸ªè´¦å·å°±æ˜¯ Admin è´¦å·ï¼Œå¦‚æœæ²¡æœ‰å¤šäººä½¿ç”¨çš„éœ€æ±‚å³å¯åœ¨ <code>Settings - Authentication</code> é‡Œå…³é—­ <code>Allow users to sign up</code>ã€‚åœ¨ Server å¡«å…¥ NS1 æˆ–è€… NS2 çš„ä¿¡æ¯å³å¯ã€‚ è€Œåï¼Œå°±å¯ä»¥å¼€å§‹é…ç½® GeoDNS äº†ã€‚</p>
<h4 id="geodns-é…ç½®">GeoDNS é…ç½®</h4>
<p>ç”±äº Maxmind GeoIP å¼€å§‹è¦æ±‚ GeoLite çš„ç”¨æˆ·æ³¨å†Œè´¦å·å¹¶ä½¿ç”¨å¯†é’¥æ‰èƒ½ä¸‹è½½æ•°æ®åº“ï¼Œæ‰€ä»¥ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦å» <a href="https://dev.maxmind.com/geoip/geolite2-free-geolocation-data">GeoLite2</a> æ³¨å†Œè´¦å·å¹¶åˆ›å»º License Keyã€‚åœ¨å¾—åˆ° Key ä»¥åï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨ NS1 å’Œ NS2 ç§å®‰è£… <code>sudo apt-get install geoipupdate</code>ï¼Œå¹¶å°† <code>AccountID</code> å’Œ <code>License Key</code> å­˜å…¥æœåŠ¡å™¨ä¸­:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo su 
</span></span><span style="display:flex;"><span>cat &gt; /etc/GeoIP.conf <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">AccountID XXXXXX
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">LicenseKey XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EditionIDs GeoLite2-Country GeoLite2-City GeoLite2-ASN
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo geoipupdate -v 
</span></span></code></pre></div><p>å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œæ‰€æœ‰çš„ <code>.mmdb</code> éƒ½ä¼šå­˜æ”¾åˆ° <code>/usr/share/GeoIP</code> è¿™ä¸ªè·¯å¾„ä¸‹é¢ã€‚å›åˆ° NS1 å’Œ NS2 çš„ <code>/etc/powerdns/pdns.d/dns.conf</code> é‡Œï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹å¹¶é‡æ–°å¯åŠ¨ PowerDNS å³å¯ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>enable-lua-records<span style="color:#f92672">=</span>yes <span style="color:#75715e"># å¯åŠ¨ lua script </span>
</span></span><span style="display:flex;"><span>launch<span style="color:#f92672">+=</span>geoip <span style="color:#75715e"># å¯åŠ¨ geoip æ’ä»¶</span>
</span></span><span style="display:flex;"><span>geoip-database-files<span style="color:#f92672">=</span>/usr/share/GeoIP/GeoLite2-City.mmdb /usr/share/GeoIP/GeoLite2-Country.mmdb /usr/share/GeoIP/GeoLite2-ASN.mmdb
</span></span><span style="display:flex;"><span>log-dns-queries<span style="color:#f92672">=</span>yes 
</span></span></code></pre></div><p>å›åˆ° PowerDNS-Admin é‡Œï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ <code>Settings - Zone Records</code> é‡Œæ‰“å¼€ LUA æ‰èƒ½åœ¨è§£æçºªå½•é‡Œä½¿ç”¨ lua scriptã€‚Lua çºªå½•æœ‰å¾ˆå¤šç”¨æ³•ï¼Œ è¯¦ç»†å¯ä»¥å‚è€ƒ<a href="https://doc.powerdns.com/authoritative/lua-records/">å®˜ç½‘</a>, è¿™é‡Œï¼Œæˆ‘åªä»‹ç» GeoDNS éœ€è¦æ€ä¹ˆè®¾ç½®ï¼š</p>
<p>æˆ‘ä»¬å¯ä»¥é¦–å…ˆè®¾ç½®ä¸€æ¡ Lua çºªå½•ç»™ <code>www.example.com</code>ï¼š<code>A    &quot;pickclosest({'249.209.110.226','160.38.17.187','66.167.146.39'})&quot;</code> ç„¶åä½¿ç”¨ <a href="https://tools.keycdn.com/ping">Ping Test</a> è¿›è¡Œæµ‹è¯•ï¼š</p>
<center>
    <img src="https://32cf906.webp.li/2024/09/www-example-com-dns.png" width="70%" alt="GeoDNS æµ‹è¯•">
</center>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸åŒçš„åœ°æ–¹å·²ç»å¯ä»¥è§£æåˆ°ä¸åŒçš„ IP äº†ï¼Œè¿™é‡Œ Loss 100% æ˜¯å› ä¸ºæµ‹è¯• IP éƒ½æ˜¯éšæœºç”Ÿæˆçš„ï¼Œç†è®ºä¸Šåº”è¯¥ä¹Ÿæ˜¯ ping ä¸é€šæ‰åˆç†ï¼Œæˆ‘ä»¬è¿™é‡Œæ¢æˆçœŸå®çš„ IP è¯•è¯•ï¼š</p>
<ol>
<li>LAX: <code>67.198.150.72</code></li>
<li>AMS: <code>78.142.195.195</code></li>
<li>SIN: <code>89.28.239.46</code></li>
</ol>
<center>
    <img src="https://32cf906.webp.li/2024/09/www-example-com-geodns-2.png" width="70%" alt="GeoDNS æµ‹è¯•">
</center>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸åŒåœ°åŒºå·²ç»è§£æåˆ°ä¸åŒåœ°åŒºçš„ IP äº†ï¼Œå…¨çƒ Ping çš„å»¶è¿Ÿä¹Ÿéƒ½é™åˆ°äº† 100ms ä»¥ä¸‹(é™¤äº†å°åº¦ä»¥å¤–)ã€‚</p>
<h2 id="ä»æ¥å…¥ç‚¹åˆ°é›†ç¾¤">ä»æ¥å…¥ç‚¹åˆ°é›†ç¾¤</h2>
<p>ä¸Šä¸€ç¯‡æ–‡ç« é‡Œä¹ŸæåŠäº†é€šè¿‡ <code>IPTABLES</code> ä»æ¥å…¥ç‚¹åˆ°é›†ç¾¤çš„ External IP çš„ç«¯å£è½¬å‘ï¼Œä½†æ˜¯ç»è¿‡æµ‹è¯•å‘ç°ï¼Œ<code>IPTABLES</code> æ— æ³•åˆ©ç”¨ä¸€äº› TCP æ‹¥å¡æ§åˆ¶ç®—æ³•ä»¥æé«˜ç½‘ç»œååå’Œå»¶è¿Ÿï¼Œç»è¿‡æ¿€æƒ…ç½‘ç»œå†²æµªï¼Œå‘ç°äº†å¦‚ä¸‹çš„ä¸€äº›å·¥å…·ï¼š</p>
<ol>
<li><a href="https://github.com/zhboner/realm">realm: A simple, high performance relay server written in rust</a></li>
<li><a href="https://github.com/go-gost/gost">gost: GO Simple Tunnel</a></li>
<li><a href="https://nginx.org/en/docs/stream/ngx_stream_core_module.html">Nginx - Stream Module</a></li>
<li><a href="https://www.haproxy.org/">Haproxy</a></li>
</ol>
<p>å¤§æ¦‚ä¸æ­¢è¿™å‡ ç§å·¥å…·ï¼Œåªæ˜¯éšæ‰‹ä¸¾å‡ºäº†è¿™å››ä¸ªã€‚è¿™äº›å¯¹æ¯” <code>IPTABLES</code> çš„å¥½å¤„æ˜¯å¯ä»¥åˆ©ç”¨ BBR ç­‰ç®—æ³•è¿›ä¸€æ­¥æé«˜ TCP çš„ä¼ è¾“ã€‚åœ¨å¯¹æ¯”äº†ä¸€ç•ªä»¥åï¼Œæˆ‘æœ€ç»ˆé€‰æ‹©äº† Nginxã€‚</p>
<h3 id="å®‰è£…-nginx">å®‰è£… Nginx</h3>
<p>ä¸å¹³æ—¶å®‰è£… Nginx ç•¥å¾®ä¸åŒï¼Œæˆ‘ä»¬ç›´æ¥é€šè¿‡ <code>apt</code> å®‰è£…çš„ Nginx ä¸å¸¦ <code>stream</code> æ¨¡å—ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>nginx -V | grep steram</code> è¿›è¡ŒæŸ¥çœ‹ã€‚è¿™é‡Œæˆ‘é€‰æ‹©ç›´æ¥å»ä¸‹è½½æºç ç¼–è¯‘å®‰è£…ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo apt -y install gcc make libssl-dev zlib1g-dev libgd-dev libgeoip-dev libpcre2-dev libpcre3-dev
</span></span><span style="display:flex;"><span>wget -O nginx.tar.gz https://nginx.org/download/nginx-1.23.1.tar.gz
</span></span><span style="display:flex;"><span>tar -xvf nginx.tar.gz <span style="color:#f92672">&amp;&amp;</span> cd ./nginx-1.23.1/
</span></span><span style="display:flex;"><span>sudo mkdir /usr/lib/nginx <span style="color:#f92672">&amp;&amp;</span> sudo mkdir /var/log/nginx <span style="color:#f92672">&amp;&amp;</span> sudo mkdir /etc/nginx <span style="color:#f92672">&amp;&amp;</span> sudo mkdir /var/cache/nginx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>./configure <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--prefix<span style="color:#f92672">=</span>/etc/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--user<span style="color:#f92672">=</span>root <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--group<span style="color:#f92672">=</span>root <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--sbin-path<span style="color:#f92672">=</span>/usr/sbin/nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--modules-path<span style="color:#f92672">=</span>/usr/lib/nginx/modules <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--conf-path<span style="color:#f92672">=</span>/etc/nginx/nginx.conf <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--error-log-path<span style="color:#f92672">=</span>/var/log/nginx/error.log <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--http-log-path<span style="color:#f92672">=</span>/var/log/nginx/access.log <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--pid-path<span style="color:#f92672">=</span>/var/run/nginx.pid <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--lock-path<span style="color:#f92672">=</span>/var/run/nginx.lock <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--http-client-body-temp-path<span style="color:#f92672">=</span>/var/cache/nginx/client_temp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--http-proxy-temp-path<span style="color:#f92672">=</span>/var/cache/nginx/proxy_temp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--http-fastcgi-temp-path<span style="color:#f92672">=</span>/var/cache/nginx/fastcgi_temp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--http-uwsgi-temp-path<span style="color:#f92672">=</span>/var/cache/nginx/uwsgi_temp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--http-scgi-temp-path<span style="color:#f92672">=</span>/var/cache/nginx/scgi_temp <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-file-aio <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-threads <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_addition_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_auth_request_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_dav_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_flv_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_gunzip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_gzip_static_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_mp4_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_random_index_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_secure_link_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_slice_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_stub_status_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_sub_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-http_v2_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-mail <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-mail_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_realip_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_ssl_module <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>--with-stream_ssl_preread_module
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo make <span style="color:#f92672">&amp;&amp;</span> sudo make install <span style="color:#f92672">&amp;&amp;</span> sudo mkdir /etc/nginx/sites-available <span style="color:#f92672">&amp;&amp;</span> sudo sudo mkdir /etc/nginx/sites-enabled
</span></span></code></pre></div><p>åœ¨å®Œæˆå®‰è£…åï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ <code>systemd</code> ä¸­åŠ å…¥é…ç½®æ–‡ä»¶å¯¹ service è¿›è¡Œæ§åˆ¶ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo su 
</span></span><span style="display:flex;"><span>cat &gt; /etc/systemd/system/nginx.service <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Unit]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Description=The NGINX HTTP and reverse proxy server
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">After=syslog.target network-online.target remote-fs.target nss-lookup.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Wants=network-online.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=forking
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PIDFile=/run/nginx.pid
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStartPre=/usr/sbin/nginx -t -c /etc/nginx/nginx.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStart=/usr/sbin/nginx -c /etc/nginx/nginx.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecReload=/usr/sbin/nginx -s reload -c /etc/nginx/nginx.conf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ExecStop=/bin/kill -s QUIT
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">PrivateTmp=true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Install]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">WantedBy=multi-user.target
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span>sudo systemctl enable --now nginx
</span></span></code></pre></div><p>è¿™æ—¶ï¼Œæˆ‘ä»¬åœ¨çœ‹ <code>nginx -V | grep stream</code> å°±èƒ½å‘ç°æ¨¡å—å·²ç»æ­£å¸¸å®‰è£…äº†ã€‚</p>
<p>é€šè¿‡ stream æ¨¡å—ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ nginx å¯¹ TCP/UDP æµé‡è¿›è¡Œè½¬å‘ï¼ŒåŒæ—¶ï¼Œè¿˜å¯ä»¥é€šè¿‡ SNI proxy æ¥è½¬å‘ HTTPS æµé‡åˆ°æºç«™ï¼Œè¿™é‡Œæˆ‘ç»™å‡ºä¸€ä¸ªæ ·ä¾‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>stream <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    upstream cluster <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        server 192.168.101.151:443;
</span></span><span style="display:flex;"><span>        server 192.168.101.152:443;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    map $ssl_preread_server_name $upstream_server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        default cluster;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    server <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        listen 443;
</span></span><span style="display:flex;"><span>        proxy_pass $upstream_server;
</span></span><span style="display:flex;"><span>        ssl_preread on;  <span style="color:#75715e"># Enable SNI reading</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ä» client åˆ° entrance å†åˆ° source çš„ä¸¤æ­¥èµ°æµç¨‹ã€‚å½“ç„¶ï¼Œé€‰æ‹© nginx çš„åŸå› ä¸ä»…ä»…æ˜¯ TCP åŠ é€Ÿï¼Œæ›´æ˜¯å› ä¸ºå¯ä»¥æ ¹æ®åŸŸåè¿›è¡Œä¸åŒåç«¯çš„åˆ†æµï¼Œè¿™äº›åº”è¯¥æ˜¯ IPTABLES/REALM è¿™äº›å·¥å…·æ— æ³•è¾¾åˆ°çš„ã€‚è€Œè‡³äºä¸ºä»€ä¹ˆä¸ç”¨ HAProxy åˆ™æ˜¯å› ä¸ºæœ¬äººä¸å–„äºä½¿ç”¨å®ƒï¼Œæ˜¯æˆ‘çš„é”™ã€‚</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>å…¶å®ä¹Ÿæ˜¯å› ä¸ºæ²¡æœ‰ AS å·åœ¨æ‰‹ï¼Œä¸ç„¶å°±æ˜¯ã€Œæˆ‘é€‰æ‹©è‡ªå»º Anycast DNS æœåŠ¡å™¨ã€äº† ï¼šï¼‰&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>æœ¬æ–‡ä¸­æ‰€æåŠçš„æ‰€æœ‰ IP åœ°å€ï¼ˆåŒ…æ‹¬ IPV4 å’Œ IPV6ï¼‰å‡æ˜¯é€šè¿‡ <a href="https://www.ipvoid.com/">IPVOID</a> éšæœºç”Ÿæˆ&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœåŸŸåæœ¬èº«ä¸éœ€è¦ä½œä¸ºè‡ªèº«çš„ NS æœåŠ¡å™¨ï¼Œåˆ™æ— éœ€è®¾ç½®èƒ¶æ°´çºªå½•ï¼Œå³ï¼Œå¯ä»¥çœç•¥è¿™ä¸€æ­¥&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>
</content>

<p>
  
  <a href="https://blog.cklau.cc/tags/homelab/">#homelab</a>
  
  <a href="https://blog.cklau.cc/tags/oauth2-proxy/">#oauth2-proxy</a>
  
  <a href="https://blog.cklau.cc/tags/nginx-ingress-controller/">#nginx-ingress-controller</a>
  
  <a href="https://blog.cklau.cc/tags/geodns/">#GeoDNS</a>
  
  <a href="https://blog.cklau.cc/tags/authoritative-dns/">#Authoritative DNS</a>
  
  <a href="https://blog.cklau.cc/tags/%E5%AE%89%E5%85%A8/">#å®‰å…¨</a>
  
  <a href="https://blog.cklau.cc/tags/%E9%9B%B6%E4%BF%A1%E4%BB%BB/">#é›¶ä¿¡ä»»</a>
  
  <a href="https://blog.cklau.cc/tags/%E5%AD%98%E5%82%A8/">#å­˜å‚¨</a>
  
  <a href="https://blog.cklau.cc/tags/%E6%9D%83%E5%A8%81-dns/">#æƒå¨ DNS</a>
  
</p>

  </main>
  <footer>


<p>
    <span><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">ç²¤ICPå¤‡2022102668å·</a></span>

&copy; 2024 <a href="https://blog.cklau.cc">Junjie LIU</a>
    <a href="https://blog.cklau.cc/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
    <br>
Hosting and images served by <a href="https://cloud.tencent.com/">Tencent Cloud</a> / <a href="https://cloudflare.com/">Cloudflare</a> / <a href="https://webp.se/">WebP Cloud Services</a>
</p>

</footer>

    
</body>

</html>
