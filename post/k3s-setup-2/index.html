<!DOCTYPE html>


































<html
  class="not-ready text-sm lg:text-base"
  style="--bg: #faf6f1"
  lang="en"
>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  
  <title>K3s/Kubernetes - 配置高可用 K3s 集群 - 若如笔记</title>

  
  <meta name="theme-color" />
  
  <meta name="description" content="在此之前 按照 K3s 的文档 生成基本的 K3s 集群非常容易。 让我们尝试将其修改为 High Availability Cluster。 单个服务器集群可以满足各种用例，但对于 Kubenetes 控制平面的正常运行时间至关重要的环境，我们需要高可用性配置。 高可用性有两种方式：
 High Availability with an External DB (for example, PostgreSQL, MySQL, MariaDB) High Availability with Embedded DB (etcd)  我选择了第二个——带有嵌入式数据库:
K3s 安装 K3s 控制节点 为了设置服务器，我按照 K3s 的说明稍作修改，因为我想自定义网络和节点名称。 这是我用于服务器安装的命令：
curl -sfL https://get.k3s.io | K3S_TOKEN=&lt;token&gt; INSTALL_K3S_EXEC=&#34;server \ --node-ip &lt;wg-node-ip&gt; \ --advertise-address &lt;node-public-ip&gt; \ --node-external-ip &lt;node-public-ip&gt; \ --flannel-iface wg0 \ --node-name &lt;node-name&gt; \ --cluster-init &#34; sh - # for whom can not access Google and Github fluently, you may try: curl -sfL https://rancher-mirror." />
  <meta name="author" content="" />
<meta content="k3s, kubernetes" name="keywords">
  

  
  
  
  
  
  
  <link rel="preload stylesheet" as="style" href="https://www.rho.ac.cn/main.min.css" />

  
  <script
    defer
    src="https://www.rho.ac.cn/highlight.min.js"
    onload="hljs.initHighlightingOnLoad();"
  ></script>
  

  
  
  
  <link
    rel="preload"
    as="image"
    href="https://www.rho.ac.cn/theme.png"
  />

  
  
  
  <link rel="preload" as="image" href="https://gravatar.xingez.me/avatar/805f51891ad1a60cd19e3e4e7539f319?s=160&amp;d=identicon" />
  
  

  
  <link rel="preload" as="image" href="https://www.rho.ac.cn/github.svg" />
  
  <link rel="preload" as="image" href="https://www.rho.ac.cn/rss.svg" />
  

  
  <link rel="icon" href="https://www.rho.ac.cn/favicon.ico" />
  <link rel="apple-touch-icon" href="https://www.rho.ac.cn/apple-touch-icon.png" />

  
  <meta name="generator" content="Hugo 0.89.4" />

  
  

  
  
  
  
  
  
  
  
  
  <meta property="og:title" content="K3s/Kubernetes - 配置高可用 K3s 集群" />
<meta property="og:description" content="K3s/Kubernetes - 配置高可用 K3s 集群" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.rho.ac.cn/post/k3s-setup-2/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-09-26T00:11:21+08:00" />



  
  <meta itemprop="name" content="K3s/Kubernetes - 配置高可用 K3s 集群">
<meta itemprop="description" content="K3s/Kubernetes - 配置高可用 K3s 集群"><meta itemprop="datePublished" content="2022-09-26T00:11:21+08:00" />

<meta itemprop="wordCount" content="631">
<meta itemprop="keywords" content="k3s,kubernetes," />
  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="K3s/Kubernetes - 配置高可用 K3s 集群"/>
<meta name="twitter:description" content="K3s/Kubernetes - 配置高可用 K3s 集群"/>

  
  
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold" href="https://www.rho.ac.cn"
      >若如笔记</a
    >
    <a
      class="btn-dark ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
    ></a>
  </div>

  <a
    class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
  ></a>

  
  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = `"#faf6f1"`.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    const darkVal = localStorage.getItem('dark');
    setDark(darkVal ? darkVal === 'true' : darkScheme.matches);

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    
    <nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6">
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/about/"
        >关于我</a
      >
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/friends/"
        >朋友们</a
      >
      
      <a
        class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal"
        href="/projects/"
        >项目</a
      >
      
    </nav>
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:mt-0 lg:ml-12 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href=" https://github.com/TerenceLiu98 "
        target="_blank"
      ></a>
      
      <a
        class="h-8 w-8 [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./rss.svg)"
        href=" https://www.rho.ac.cn/index.xml "
        target="_blank"
      ></a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-8 pt-20 pb-32 dark:prose-invert"
    >
      

<article>
  <header class="mb-10">
    <h1 class="!my-0 pb-2.5">K3s/Kubernetes - 配置高可用 K3s 集群</h1>

    
    <div class="text-sm opacity-60">
      
      
      
      
      Published Sep 25, 2022
      
      
      
    </div>
    
  </header>


  
     
    <a
      class="mr-1.5 mb-1.5 rounded-lg bg-black/[3%] px-2 py-1 no-underline dark:bg-white/[8%]"
      href="https://www.rho.ac.cn/tags/k3s"
      >k3s</a>
     
    <a
      class="mr-1.5 mb-1.5 rounded-lg bg-black/[3%] px-2 py-1 no-underline dark:bg-white/[8%]"
      href="https://www.rho.ac.cn/tags/kubernetes"
      >kubernetes</a>
    
  
  <hr>
  <section><h1 id="在此之前">在此之前</h1>
<p>按照 <a href="https://doc.k3s.io">K3s 的文档</a> 生成基本的 K3s 集群非常容易。 让我们尝试将其修改为 High Availability Cluster。 单个服务器集群可以满足各种用例，但对于 Kubenetes 控制平面的正常运行时间至关重要的环境，我们需要高可用性配置。 高可用性有两种方式：</p>
<ol>
<li>High Availability with an External DB (for example, <a href="https://www.postgresql.org/">PostgreSQL</a>, <a href="https://www.mysql.com/">MySQL</a>,  <a href="https://mariadb.org/">MariaDB</a>)</li>
<li>High Availability with Embedded DB (<a href="https://etcd.io/">etcd</a>)</li>
</ol>
<p>我选择了第二个——带有嵌入式数据库:</p>
<h2 id="k3s-安装">K3s 安装</h2>
<h3 id="k3s-控制节点">K3s 控制节点</h3>
<p>为了设置服务器，我按照 <a href="https://k3s.io">K3s</a> 的说明稍作修改，因为我想自定义网络和节点名称。 这是我用于服务器安装的命令：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -sfL https://get.k3s.io | K3S_TOKEN<span style="color:#f92672">=</span>&lt;token&gt;  INSTALL_K3S_EXEC<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;server \
</span><span style="color:#e6db74">                            --node-ip &lt;wg-node-ip&gt; \
</span><span style="color:#e6db74">                            --advertise-address &lt;node-public-ip&gt; \
</span><span style="color:#e6db74">                            --node-external-ip &lt;node-public-ip&gt; \
</span><span style="color:#e6db74">                            --flannel-iface wg0   \
</span><span style="color:#e6db74">                            --node-name &lt;node-name&gt; \ 
</span><span style="color:#e6db74">                            --cluster-init &#34;</span> sh -

<span style="color:#75715e"># for whom can not access Google and Github fluently, you may try:</span>
curl -sfL https://rancher-mirror.oss-cn-beijing.aliyuncs.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR<span style="color:#f92672">=</span>cn <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>                            K3S_TOKEN<span style="color:#f92672">=</span>&lt;token&gt;  INSTALL_K3S_EXEC<span style="color:#f92672">=</span><span style="color:#e6db74">&#34; \
</span><span style="color:#e6db74">                            server https://&lt;server-1-external-ip&gt;:6443\
</span><span style="color:#e6db74">                            --node-ip &lt;wg-node-ip&gt; \
</span><span style="color:#e6db74">                            --advertise-address &lt;node-public-ip&gt; \
</span><span style="color:#e6db74">                            --node-external-ip &lt;node-public-ip&gt; \
</span><span style="color:#e6db74">                            --flannel-iface wg0   \
</span><span style="color:#e6db74">                            --node-name &lt;node-name&gt; \ 
</span><span style="color:#e6db74">                            --cluster-init &#34;</span> sh -
</code></pre></div><p>您可以在其中看到 <code>--node-ip</code> 是为节点的 IP 地址； <code>--advertise-address</code> 是 apiserver 用户向集群其他节点发布的 ip 地址； <code>--node-external-ip</code> 是为节点宣告的外部 ip 地址； <code>--flannel-iface</code>  是 flannel 所使用的网卡设备。</p>
<p>为了生成令牌，我使用了 <code>openssl rand --hex 16</code>.</p>
<p>同样，对于第二台服务器，您可以使用上面相同的配置和 IP 替换。</p>
<h3 id="k3s-计算节点">K3s 计算节点</h3>
<p>对于 K3s 计算节点，您可以简单地重用上述命令并进行修改：将 <code>server</code> 更改为 <code>agent</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">curl -sfL https://rancher-mirror.oss-cn-beijing.aliyuncs.com/k3s/k3s-install.sh | INSTALL_K3S_MIRROR<span style="color:#f92672">=</span>cn K3S_TOKEN<span style="color:#f92672">=</span>&lt;TOKEN&gt; INSTALL_K3S_EXEC<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;agent 
</span><span style="color:#e6db74">                    --server https://&lt;server-ip&gt;:6443 
</span><span style="color:#e6db74">                    --node-ip &lt;node-wg-ip&gt; 
</span><span style="color:#e6db74">                    --node-external-ip &lt;node-wg-ip&gt; 
</span><span style="color:#e6db74">                    --flannel-iface wg0 
</span><span style="color:#e6db74">                    --node-name &lt;node-name&gt;&#34;</span> sh -
</code></pre></div><p>在服务端和节点安装完成后，可以检查服务端是否能正确到达节点：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo kubectl get nodes -o wide
<span style="color:#75715e"># NAME      STATUS   ROLES                       AGE   VERSION        INTERNAL-IP    EXTERNAL-IP     OS-IMAGE           KERNEL-VERSION      CONTAINER-RUNTIME</span>
<span style="color:#75715e"># cantor    Ready    control-plane,etcd,master   9h    v1.24.6+k3s1   10.210.120.2   xxx.xxx.xxx.xxx   Ubuntu 20.04 LTS   5.4.0-126-generic   containerd://1.6.8-k3s1</span>
<span style="color:#75715e"># hilbert   Ready    control-plane,etcd,master   9h    v1.24.6+k3s1   10.210.120.1   xxx.xxx.xxx.xxx   Ubuntu 20.04 LTS   5.4.0-126-generic   containerd://1.6.8-k3s1</span>
<span style="color:#75715e"># newton    Ready    worker                      9h    v1.24.6+k3s1   10.210.120.3   10.210.120.3    Ubuntu 20.04 LTS   5.4.0-126-generic   containerd://1.6.8-k3s1</span>

sudo kubectl top nodes
<span style="color:#75715e"># NAME      CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span>
<span style="color:#75715e"># cantor    445m         22%    2451Mi          71%</span>
<span style="color:#75715e"># hilbert   300m         7%     3942Mi          52%</span>
<span style="color:#75715e"># newton    90m          9%     1118Mi          56%</span>
</code></pre></div><h2 id="helm-安装">Helm 安装</h2>
<p><a href="https://helm.sh">Helm</a> 是的包管理器，通常我们可以使用它来下载并安装预打包的应用程序到我们的集群。 要安装它，我们可以去 hel m的 GitHub release 找到编译好的二进制文件并下载。 以下是 Linux amd64 的示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">wget https://get.helm.sh/helm-v3.10.0-linux-amd64.tar.gz -O helm.tar.gz

tar -xvf helm.tar.gz
sudo mv linux-amd64/helm /usr/local/bi

helm version
<span style="color:#75715e"># version.BuildInfo{Version:&#34;v3.10.0&#34;, GitCommit:&#34;ce66412a723e4d89555dc67217607c6579ffcb21&#34;, GitTreeState:&#34;clean&#34;, GoVersion:&#34;go1.18.6&#34;}</span>
</code></pre></div><h2 id="更改-containerd-的镜像可选">更改 Containerd 的镜像（可选）</h2>
<p>由于某些原因，某些地区的网络可能会卡在「拉镜像」这一步，无法连接（或非常慢）某些网站，遗憾的是，gcr.io<code>和</code>quay.io`都在列表中。 因此，我们可能需要换成物理位置更近的镜像。</p>
<p>例如：我们可以将 <code>quay.io</code> 替换为 <code>https://quay-mirror.qiniu.com</code> 和 <code>gcr.io</code> 我们可以使用 <code>https://registry.aliyuncs.com</code>。 对于docker，我们可以使用 <a href="https://www.daocloud.io/">Daocloud</a> 的脚本来更新镜像。 这可能有助于加快后续步骤中的安装过程。</p>
<h2 id="cert-manager-安装和配置">Cert-Manager 安装和配置</h2>
<p><a href="https://cert-manager.io/">Cert-Manager</a> 是一个云原生的证书管理工具，可以帮助我们自动签署 Let&rsquo;s Encrypt with ACME 的 SSL/TLC 证书。 通常，Cert-Manager 提供两种质询验证 - HTTP01 和 DNS01 质询。 在这里，我们使用 DNS01，但现在，让我们先安装 Cert-Manager。</p>
<ol>
<li>添加 helm 存储库并更新 repo：<code>sudo helm repo add jetstack https://charts.jetstack.io &amp;&amp; sudo helm repo update</code> [^1]</li>
<li>安装证书管理器：<code>helm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --version v1.9.1 --set installCRDs=true</code>（创建一个 namespace，并指定 cert-manager 的版本是 v1.9.1；安装CRD资源）</li>
<li>检查证书管理器的状态：<code>sudo kubectl get pods --namespace cert-manager</code></li>
</ol>
<p>安装 cert-manager 后，我们需要去 <a href="https://dash.cloudflare.com/profile">Cloudflare 的仪表板</a> 创建一个带有“编辑区域 DNS”模板的 API 令牌，设置权限：<code>Zone - DNS - Edit </code>和<code>Zone-Zone-Read</code>，其他可以默认。 请记住，API 只会显示一个，您可能需要在打开选项卡之前复制它。</p>
<p>创建一个 yaml（<code>cloudflare-api-token-secret.yaml</code>，您可以更改文件名）并启动一个新的 Issuer：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cloudflare-api-token-secret</span> <span style="color:#75715e"># you may change the name</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">cert-manager</span>
<span style="color:#f92672">type</span>: <span style="color:#ae81ff">Opaque</span>
<span style="color:#f92672">stringData</span>:
  <span style="color:#f92672">api-token</span>: <span style="color:#ae81ff">&lt;CF-API-TOKEN&gt;</span>
</code></pre></div><p>创建另一个 yaml (<code>ClusterIssuer.yaml</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">cert-manager.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterIssuer</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">letsencrypt-dns01</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">acme</span>:
    <span style="color:#f92672">privateKeySecretRef</span>:
      <span style="color:#f92672">name</span>: <span style="color:#ae81ff">letsencrypt-dns01</span>
    <span style="color:#f92672">email</span>: <span style="color:#ae81ff">&lt;your-email-addr&gt;</span>
    <span style="color:#f92672">server</span>: <span style="color:#ae81ff">https://acme-v02.api.letsencrypt.org/directory</span>
    <span style="color:#f92672">solvers</span>:
    - <span style="color:#f92672">dns01</span>:
        <span style="color:#f92672">cloudflare</span>:
          <span style="color:#f92672">email</span>: <span style="color:#ae81ff">&lt;your-cf-account-email-addr&gt;</span>
          <span style="color:#f92672">apiTokenSecretRef</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cloudflare-api-token-secret</span> <span style="color:#75715e"># need to be same with the above yaml metadata&#39;s name</span>
            <span style="color:#f92672">key</span>: <span style="color:#ae81ff">api-token</span>
</code></pre></div><p>创建第三个 yaml (<code>Certificate.yaml</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">cert-manager.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Certificate</span>
<span style="color:#f92672">metadata</span>:
 <span style="color:#f92672">name</span>: <span style="color:#ae81ff">&lt;domain-name&gt;</span> <span style="color:#75715e"># you may change the name</span>
 <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">default</span>
<span style="color:#f92672">spec</span>:
 <span style="color:#f92672">dnsNames</span>:
  - <span style="color:#ae81ff">example.com</span>
  - <span style="color:#e6db74">&#34;*.example.com&#34;</span>
 <span style="color:#f92672">issuerRef</span>:
   <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterIssuer</span>
   <span style="color:#f92672">name</span>: <span style="color:#ae81ff">letsencrypt-dns01</span> <span style="color:#75715e"># Cite ClusterIssuer and use DNS01 for the challenge</span>
 <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">&lt;secret-name&gt;</span> <span style="color:#75715e"># the certificate with store in this cecret and you may change it </span>
</code></pre></div><p>然后，应用这三个yaml文件，稍等片刻。 使用 <code>sudo kubectl describe certificate</code> 检查状态。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo kubectl describe certificate
NAME           READY    SECRET       AGE
&lt;domain-name&gt;   True    &lt;secret&gt;      1m
</code></pre></div><p>如果准备就绪，则表示证书已颁发。</p>
<h2 id="rancher-安装">Rancher 安装</h2>
<p>安装 Rancher 很容易，Rancher 是一个完整的软件堆栈，适用于采用容器的团队。 它解决了管理多个 Kubernetes 集群的操作和安全挑战，同时为 DevOps 团队提供了用于运行容器化工作负载的集成工具。</p>
<p>类似于 Cert-Manager 的安装：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">sudo helm repo add rancher-latest https://releases.rancher.com/server-charts/latest <span style="color:#75715e"># add </span>
sudo helm install rancher rancher-latest/rancher --namespace cattle-system --create-namespace --set hostname<span style="color:#f92672">=</span>rancher.k3s.cklau.ml --set bootstrapPassword<span style="color:#f92672">=</span>admin --set ingress.tls.source<span style="color:#f92672">=</span>secret
</code></pre></div><p>然后，我们需要为 Rancher 创建一个证书和一个入口，我们可以在其中使用我们的域访问：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">cert-manager.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Certificate</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tls-rancher-ingress</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">cattle-system</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">&lt;secret-name&gt;</span>
  <span style="color:#f92672">commonName</span>: <span style="color:#e6db74">&#39;*.example.com&#39;</span>
  <span style="color:#f92672">dnsNames</span>:
  - <span style="color:#e6db74">&#39;*.example.com&#39;</span>
  <span style="color:#f92672">issuerRef</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">letsencrypt</span>
    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterIssuer</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">rancher</span>
  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">cattle-system</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">cert-manager.io/cluster-issuer</span>: <span style="color:#ae81ff">letsencrypt-dns01</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">rules</span>:
  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">rancher.example.com</span>
    <span style="color:#f92672">http</span>:
      <span style="color:#f92672">paths</span>:
      - <span style="color:#f92672">backend</span>:
          <span style="color:#f92672">service</span>:
            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">rancher</span>
            <span style="color:#f92672">port</span>:
              <span style="color:#f92672">number</span>: <span style="color:#ae81ff">80</span>
        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">ImplementationSpecific</span>
  <span style="color:#f92672">tls</span>:
  - <span style="color:#f92672">hosts</span>:
    - <span style="color:#ae81ff">rancher.example.com</span>
    <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">&lt;secret-name&gt;</span>
</code></pre></div><p>应用 yaml 后，我们可以检查 rancher 是否正确安装：<code>sudo kubectl get pods --namespace cattle-system</code> 并检查 <code>rancher.example.com</code>。</p>
<p>[^1]：出于某种原因，我遇到了 helm 的一些问题，但它们都与 <code>KUBECONFIG</code> 相关。 因此，您可以将 <code>KUBECONFIG</code> 复制到 <code>~/.kube/config</code>，这可能会解决您的问题：<code>sudo cat /etc/rancher/k3s/k3s.yaml &gt; ~/.kube/config</code></p>
</section>

  
  

  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a class="flex w-1/2 items-center p-6 pr-3 no-underline" href="https://www.rho.ac.cn/post/k3s-setup-extra-1/"
      ><span class="mr-1.5">←</span><span>K3s/Kubernetes - 番外：自建 Docker 镜像站</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end p-6 pl-3 no-underline"
      href="https://www.rho.ac.cn/post/k3s-setup-1/"
      ><span>K3s/Kubernetes - 快速启动 K3s 服务</span><span class="ml-1.5">→</span></a
    >
    
  </nav>
  

  
  
  <div id="disqus_thread"></div>
  <script>
    const disqusShortname = 'blog-cklau-cc';
    const script = document.createElement('script');
    script.src = 'https://' + disqusShortname + '.disqus.com/embed.js';
    script.setAttribute('data-timestamp', +new Date());
    document.head.appendChild(script);
  </script>
  
</article>


    </main>

    <footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-80">
  <div class="mr-auto">
    <a href="https://beian.miit.gov.cn">粤ICP备2022102668号</a>
  </div>
  &copy; 2016 - 2023 <a class="link" href="https://github.com/TerenceLiu98">Terence Liu</a>
</footer>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1844674035384472"
     crossorigin="anonymous"></script>
  </body>
</html>
